# 需求規格書 (PRD)

## 製程視覺 AI 分析系統

**文件編號**: SMAI-PRD-2024-001
**專案名稱**: 製程視覺 AI 分析系統 (Process Vision AI)
**版本**: 1.1
**日期**: 2025-01-30
**單位**: 再生廠智慧製造

---

## 文件資訊

| 項目 | 內容 |
|------|------|
| **需求單位** | 再生廠智慧製造 |
| **系統開發** | 自建 + 研華整合 |
| **目標上線日** | 2024 Q2 |
| **撰寫人** | |
| **審核人** | |

---

## 修訂紀錄

| 版本 | 日期 | 修訂內容 | 作者 |
|------|------|---------|------|
| 0.1 | 2024-01-10 | 初稿 | |
| 1.0 | 2024-01-15 | 正式版 | |
| 1.1 | 2025-01-30 | 文件審閱更新、硬體報價待更新標註 | |

---

## 1. 專案概述

### 1.1 專案背景

目前製程週期時間量測仰賴人工秒錶計時，存在以下問題：
- 人力成本高（每週約 8 小時）
- 數據準確度不穩定（人為誤差）
- 無法即時監控異常
- 難以進行長期趨勢分析

### 1.2 專案目標

建置製程視覺 AI 分析系統，實現：

| 目標 | 說明 | 量化指標 |
|------|------|---------|
| 自動化量測 | AI 自動識別製程動作並計時 | 減少 80% 人工工時 |
| 提升準確度 | 消除人為量測誤差 | 準確度 > 95% |
| 即時監控 | 邊緣運算即時偵測 | 延遲 < 100ms |
| 數據整合 | 與 WISE-IoTSuite 整合 | 關聯 MES 數據 |

### 1.3 專案範圍

#### 範圍內 (In Scope)

| 項目 | 說明 |
|------|------|
| 邊緣 AI 推論 | VisionAI Edge 即時影像分析 |
| 批次影片分析 | Mac 伺服器批次處理 |
| 製程分段識別 | 自動識別取料/組裝/檢查等動作 |
| 週期時間分析 | 計算並統計週期時間 |
| 學習統計 | 趨勢分析、標準時間建議 |
| 數據整合 | 與 WISE-IoTSuite 串接 |

#### 範圍外 (Out of Scope)

| 項目 | 說明 | 負責單位 |
|------|------|---------|
| ERP 系統整合 | 工單主檔同步 | 資訊部協調 |
| IT 基礎建設 | 網路/伺服器維運 | 資訊部 |
| 正式環境維運 | 系統維運支援 | 資訊部 |

### 1.4 利害關係人

| 角色 | 單位 | 職責 |
|------|------|------|
| 專案發起人 | 再生廠 | 預算核准、策略決策 |
| 產品負責人 | 智慧製造 | 需求定義、驗收確認 |
| 技術負責人 | 智慧製造 | 技術規格、POC 執行 |
| 系統整合 | 智慧製造/研華 | 系統開發與整合 |
| 使用者 | 生產單位 | 系統操作、回饋 |
| 資訊部 | 資訊部 | 維運支援、資安審核 |

---

## 2. 使用者需求

### 2.1 使用者角色

| 角色 | 說明 | 主要功能 |
|------|------|---------|
| IE 工程師 | 製程改善分析 | 影片分析、報表產出 |
| 現場主管 | 生產監控 | 即時監控、異常通知 |
| 品質人員 | 品質追溯 | 影像查詢、異常回溯 |
| 系統管理員 | 系統維護 | 設備管理、模型管理 |

### 2.2 使用者故事 (User Stories)

#### US-01: 批次影片分析
```
作為 IE 工程師
我想要 上傳製程影片並自動分析
以便 快速取得週期時間數據，不需人工計時
```

**驗收條件**:
- [ ] 支援上傳 MP4/MOV 格式，檔案大小 < 500MB
- [ ] 分析完成後自動產生分段結果
- [ ] 分段準確率 > 85%
- [ ] 處理速度 > 實時 3 倍

#### US-02: 分段邊界調整
```
作為 IE 工程師
我想要 手動調整 AI 識別的分段邊界
以便 校正錯誤的分段結果
```

**驗收條件**:
- [ ] 時間軸可拖拉調整邊界
- [ ] 支援分段新增/刪除/合併
- [ ] 儲存修正後的結果
- [ ] 修正結果可用於模型學習

#### US-03: 即時監控
```
作為 現場主管
我想要 即時查看各工站的作業狀態
以便 及時發現異常並處理
```

**驗收條件**:
- [ ] 即時顯示各工站狀態（作業中/待料/異常）
- [ ] 異常事件即時通知
- [ ] 延遲 < 5 秒
- [ ] 支援多工站同時監控

#### US-04: 週期時間報表
```
作為 IE 工程師
我想要 查看週期時間統計報表
以便 分析製程效率並找出改善機會
```

**驗收條件**:
- [ ] 顯示平均/最大/最小/標準差
- [ ] 支援時間區間篩選
- [ ] 支援工站/產品篩選
- [ ] 圖表視覺化呈現

#### US-05: 學習統計與建議
```
作為 IE 工程師
我想要 系統自動學習歷史數據並建議標準時間
以便 建立更準確的製程標準
```

**驗收條件**:
- [ ] 自動計算各分段的統計數據
- [ ] 顯示趨勢（改善中/穩定/惡化）
- [ ] 建議標準時間（基於統計）
- [ ] 支援一鍵套用建議值

#### US-06: 設備管理
```
作為 系統管理員
我想要 管理 VisionAI Edge 設備狀態
以便 確保系統正常運作
```

**驗收條件**:
- [ ] 顯示設備連線狀態
- [ ] 顯示設備資源使用率（CPU/GPU/溫度）
- [ ] 離線告警通知
- [ ] 支援遠端重啟

#### US-07: 模型管理
```
作為 系統管理員
我想要 管理 AI 模型版本並部署到 Edge 設備
以便 持續改善識別準確率
```

**驗收條件**:
- [ ] 模型版本列表
- [ ] 支援一鍵部署到指定 Edge
- [ ] 部署狀態追蹤
- [ ] 支援版本回滾

---

## 3. 功能需求

### 3.1 功能架構

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        製程視覺 AI 分析系統                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                         前端應用層                               │   │
│  │                                                                 │   │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐      │   │
│  │  │  儀表板   │ │ 影片分析  │ │ 學習統計  │ │ 設備管理  │      │   │
│  │  │ Dashboard │ │ Analysis  │ │ Learning  │ │  Devices  │      │   │
│  │  └───────────┘ └───────────┘ └───────────┘ └───────────┘      │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                         後端服務層                               │   │
│  │                                                                 │   │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐      │   │
│  │  │ 影片管理  │ │ 分析引擎  │ │ 統計服務  │ │ 整合服務  │      │   │
│  │  │  Video    │ │  YOLO     │ │Statistics │ │Integration│      │   │
│  │  └───────────┘ └───────────┘ └───────────┘ └───────────┘      │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                         外部整合層                               │   │
│  │                                                                 │   │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐                    │   │
│  │  │WISE-IoT   │ │ VisionAI  │ │Cloudinary │                    │   │
│  │  │  Suite    │ │   Edge    │ │  Storage  │                    │   │
│  │  └───────────┘ └───────────┘ └───────────┘                    │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 功能清單

| 模組 | 功能編號 | 功能名稱 | 優先級 | 狀態 |
|------|---------|---------|--------|------|
| **儀表板** | F-DB-01 | 統計概覽 | P0 | 已完成 |
| | F-DB-02 | 最近分析列表 | P0 | 已完成 |
| | F-DB-03 | 工站狀態監控 | P1 | 待開發 |
| **影片管理** | F-VM-01 | 影片上傳 | P0 | 已完成 |
| | F-VM-02 | 影片列表 | P0 | 已完成 |
| | F-VM-03 | 影片刪除 | P0 | 已完成 |
| | F-VM-04 | 影片預覽 | P1 | 已完成 |
| **製程分析** | F-AN-01 | 自動分析 | P0 | 已完成 |
| | F-AN-02 | 分段顯示 | P0 | 已完成 |
| | F-AN-03 | 時間軸編輯 | P0 | 已完成 |
| | F-AN-04 | 分段拖拉排序 | P1 | 已完成 |
| | F-AN-05 | 分段新增/刪除 | P1 | 待開發 |
| **學習統計** | F-LS-01 | 統計數據顯示 | P0 | 已完成 |
| | F-LS-02 | 趨勢分析 | P0 | 已完成 |
| | F-LS-03 | 標準時間建議 | P1 | 已完成 |
| | F-LS-04 | 一鍵套用 | P1 | 已完成 |
| **設備管理** | F-DM-01 | 設備列表 | P1 | 待開發 |
| | F-DM-02 | 狀態監控 | P1 | 待開發 |
| | F-DM-03 | 遠端重啟 | P2 | 待開發 |
| **模型管理** | F-MM-01 | 模型列表 | P2 | 待開發 |
| | F-MM-02 | 模型部署 | P2 | 待開發 |
| | F-MM-03 | 版本回滾 | P2 | 待開發 |
| **整合** | F-IN-01 | IoTSuite 串接 | P0 | 待開發 |
| | F-IN-02 | Edge 資料接收 | P1 | 待開發 |
| | F-IN-03 | DataInsight ETL | P1 | 待開發 |

### 3.3 功能詳細規格

#### F-AN-01: 自動分析

**功能說明**: 對上傳的製程影片執行 YOLO AI 分析，自動識別製程分段

**輸入**:
- 影片 ID
- 分析參數（選用）

**處理邏輯**:
1. 從 Cloudinary 取得影片 URL
2. 更新影片狀態為「分析中」
3. 呼叫 YOLO 分析引擎
4. 每 5 幀執行一次物件偵測
5. 偵測場景變化點
6. 判定分段邊界
7. 分類分段類型
8. 儲存分析結果
9. 更新影片狀態為「已分析」

**輸出**:
```json
{
  "video_id": "abc123",
  "cycle_time": 45.2,
  "segments": [
    {
      "name": "取料",
      "start": 0.0,
      "end": 8.5,
      "duration": 8.5
    },
    {
      "name": "組裝",
      "start": 8.5,
      "end": 35.2,
      "duration": 26.7
    }
  ],
  "statistics": {
    "total_frames": 1356,
    "fps": 30,
    "objects_detected": 22
  }
}
```

**效能需求**:
- 處理速度 > 實時 3 倍
- 記憶體使用 < 4GB

---

#### F-IN-01: IoTSuite 串接

**功能說明**: 與 WISE-IoTSuite 數據中台串接，接收 Edge 推論結果並回寫分析數據

**整合方式**:

| 方向 | 協定 | 用途 |
|------|------|------|
| Edge → IoTSuite | MQTT | 即時推論結果 |
| IoTSuite → Mac | REST API | 歷史資料查詢 |
| Mac → IoTSuite | REST API | 分析結果回寫 |

**MQTT Topic 設計**:
```
edge/{edge_id}/inference    # 推論結果
edge/{edge_id}/status       # 設備狀態
edge/{edge_id}/alert        # 告警事件
```

**訊息格式**:
```json
{
  "edge_id": "MIC730AI-001",
  "camera_id": "CAM-A01",
  "timestamp": "2024-01-15T10:30:45.123Z",
  "detections": [
    {
      "class": "person",
      "confidence": 0.95,
      "bbox": [120, 80, 450, 520]
    }
  ],
  "scene_type": "operation"
}
```

---

## 4. 非功能需求

### 4.1 效能需求

| 編號 | 需求項目 | 規格 | 驗證方法 |
|------|---------|------|---------|
| NFR-P01 | Edge 推論延遲 | < 100ms | 實測 |
| NFR-P02 | Edge 處理幀率 | > 25 FPS | 實測 |
| NFR-P03 | 批次處理速度 | > 3x 實時 | 實測 |
| NFR-P04 | API 回應時間 | < 500ms (p95) | 壓測 |
| NFR-P05 | 頁面載入時間 | < 3 秒 | Lighthouse |

### 4.2 可用性需求

| 編號 | 需求項目 | 規格 | 驗證方法 |
|------|---------|------|---------|
| NFR-A01 | 系統可用率 | > 99.5% | 監控統計 |
| NFR-A02 | Edge 正常運作率 | > 99% | 監控統計 |
| NFR-A03 | 資料完整性 | 100% | 資料比對 |
| NFR-A04 | 故障復原時間 | < 30 分鐘 | 演練 |

### 4.3 安全性需求

| 編號 | 需求項目 | 規格 | 驗證方法 |
|------|---------|------|---------|
| NFR-S01 | 網路隔離 | OT/IT 網段分離 | 網路架構審查 |
| NFR-S02 | API 認證 | JWT Token | 安全測試 |
| NFR-S03 | 傳輸加密 | TLS 1.3 | 安全掃描 |
| NFR-S04 | 存取控制 | RBAC | 功能測試 |

### 4.4 擴展性需求

| 編號 | 需求項目 | 規格 | 驗證方法 |
|------|---------|------|---------|
| NFR-E01 | 攝影機擴充 | 支援 50 路以上 | 架構評估 |
| NFR-E02 | Edge 擴充 | 支援 10 台以上 | 架構評估 |
| NFR-E03 | 資料保留 | 支援 1 年以上 | 容量規劃 |

### 4.5 相容性需求

| 編號 | 需求項目 | 規格 | 驗證方法 |
|------|---------|------|---------|
| NFR-C01 | 瀏覽器支援 | Chrome, Edge, Safari 最新版 | 相容測試 |
| NFR-C02 | 影片格式 | MP4, MOV, AVI | 功能測試 |
| NFR-C03 | 攝影機協定 | RTSP H.264/H.265 | 整合測試 |

---

## 5. 介面需求

### 5.1 使用者介面

#### 5.1.1 儀表板

```
┌─────────────────────────────────────────────────────────────────────────┐
│  Process Vision                                    👤 Admin  ⚙️ 設定   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐           │
│  │   12            │ │   8             │ │   45.2s         │           │
│  │   已分析影片    │ │   本週分析      │ │   平均週期時間  │           │
│  └─────────────────┘ └─────────────────┘ └─────────────────┘           │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  最近分析                                                       │   │
│  │  ┌─────────────────────────────────────────────────────────┐   │   │
│  │  │  製程A_20240115.mp4   │  已完成  │  45.2s  │  查看      │   │   │
│  │  │  製程B_20240114.mp4   │  已完成  │  42.8s  │  查看      │   │   │
│  │  │  製程A_20240113.mp4   │  已完成  │  46.1s  │  查看      │   │   │
│  │  └─────────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 5.1.2 分析頁面

```
┌─────────────────────────────────────────────────────────────────────────┐
│  製程分析 - 製程A_20240115.mp4                                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                                                                 │   │
│  │                    [ 影片播放器 ]                               │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  時間軸                                                         │   │
│  │  ├─ 取料 ─┼── 定位 ──┼───── 組裝 ─────┼─ 檢查 ─┼─ 放置 ─┤     │   │
│  │  0s      8.5s      12.3s           35.6s    42.1s    45.2s     │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  分段列表                                        總週期: 45.2s  │   │
│  │  ┌─────────────────────────────────────────────────────────┐   │   │
│  │  │  ☰ 取料    │  0.0s - 8.5s   │  8.5s   │  ✏️  🗑️        │   │   │
│  │  │  ☰ 定位    │  8.5s - 12.3s  │  3.8s   │  ✏️  🗑️        │   │   │
│  │  │  ☰ 組裝    │  12.3s - 35.6s │  23.3s  │  ✏️  🗑️        │   │   │
│  │  │  ☰ 檢查    │  35.6s - 42.1s │  6.5s   │  ✏️  🗑️        │   │   │
│  │  │  ☰ 放置    │  42.1s - 45.2s │  3.1s   │  ✏️  🗑️        │   │   │
│  │  └─────────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│                                         [ 儲存變更 ]  [ 重新分析 ]     │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 5.2 系統介面

#### 5.2.1 與 WISE-IoTSuite 介面

| 介面名稱 | 方向 | 協定 | 說明 |
|---------|------|------|------|
| MQTT 推論結果 | Edge → IoTSuite | MQTT | 即時推論資料 |
| REST 時序查詢 | IoTSuite → Mac | HTTPS | 歷史資料查詢 |
| REST 資料回寫 | Mac → IoTSuite | HTTPS | 分析結果儲存 |

#### 5.2.2 與 DataInsight 介面

| 介面名稱 | 方向 | 協定 | 說明 |
|---------|------|------|------|
| SQL 跨源查詢 | Mac → DataInsight | HTTPS | 關聯 MES + Vision |
| ETL Pipeline | DataInsight → 主題DB | 內部 | 資料轉換整合 |

---

## 6. 資料需求

### 6.1 資料模型

```
┌─────────────────┐       ┌─────────────────┐       ┌─────────────────┐
│    pv_videos    │       │pv_analysis_results│     │pv_segment_templates│
├─────────────────┤       ├─────────────────┤       ├─────────────────┤
│ id (PK)         │───┐   │ id (PK)         │   ┌───│ id (PK)         │
│ name            │   │   │ video_id (FK)   │───┤   │ name            │
│ status          │   └──▶│ cycle_time      │   │   │ standard_time   │
│ cloudinary_url  │       │ segments (JSON) │   │   │ tolerance       │
│ duration        │       │ fps             │   │   │ sort_order      │
│ created_at      │       │ created_at      │   │   │ created_at      │
└─────────────────┘       └─────────────────┘   │   └─────────────────┘
                                                │
┌─────────────────┐       ┌─────────────────┐   │
│pv_segment_history│      │ pv_learning_stats│   │
├─────────────────┤       ├─────────────────┤   │
│ id (PK)         │       │ id (PK)         │   │
│ video_id (FK)   │       │ template_id (FK)│◀──┘
│ template_id (FK)│       │ sample_count    │
│ segment_name    │       │ avg_duration    │
│ actual_duration │       │ std_deviation   │
│ deviation       │       │ trend           │
│ created_at      │       │ updated_at      │
└─────────────────┘       └─────────────────┘
```

### 6.2 資料量估算

| 資料類型 | 日增量 | 月增量 | 年增量 | 保留策略 |
|---------|--------|--------|--------|---------|
| 影片 (Cloudinary) | 5 支 | 150 支 | 1,800 支 | 永久 |
| 分析結果 | 5 筆 | 150 筆 | 1,800 筆 | 永久 |
| Edge 推論日誌 | 2.6M 筆 | 78M 筆 | 936M 筆 | 30 天 |
| 學習統計 | - | - | - | 永久 |

### 6.3 資料備份

| 備份類型 | 頻率 | 保留期限 | 儲存位置 |
|---------|------|---------|---------|
| 資料庫完整備份 | 每日 | 30 天 | NAS |
| 資料庫增量備份 | 每小時 | 7 天 | NAS |
| 影片備份 | 即時 | 永久 | Cloudinary |

---

## 7. 約束條件

### 7.1 技術約束

| 約束 | 說明 |
|------|------|
| 須使用研華 VisionAI Edge | 已有研華合作關係 |
| 須整合 WISE-IoTSuite | 現有數據中台 |
| Mac 伺服器須在 IT 機房 | 資安與維運考量 |
| 影片儲存使用 Cloudinary | 現有服務 |

### 7.2 業務約束

| 約束 | 說明 |
|------|------|
| 預算上限 | NT$100 萬以內 |
| 上線時程 | 2024 Q2 |
| 須符合 ISO 27001:2022 | 公司資安政策 |

### 7.3 法規約束

| 約束 | 說明 |
|------|------|
| 人臉隱私 | 需自動馬賽克處理 |
| 資料保存 | 依公司規定 |

---

## 8. 驗收標準

### 8.1 功能驗收

| 編號 | 驗收項目 | 驗收標準 | 驗證方法 |
|------|---------|---------|---------|
| UAT-F01 | 影片上傳 | 成功上傳並儲存 | 操作測試 |
| UAT-F02 | 自動分析 | 分析完成並產生分段 | 操作測試 |
| UAT-F03 | 分段編輯 | 可調整並儲存 | 操作測試 |
| UAT-F04 | 學習統計 | 顯示正確統計數據 | 數據驗證 |
| UAT-F05 | IoTSuite 整合 | 資料正確傳輸 | 整合測試 |

### 8.2 效能驗收

| 編號 | 驗收項目 | 驗收標準 | 驗證方法 |
|------|---------|---------|---------|
| UAT-P01 | 分析速度 | > 3x 實時 | 效能測試 |
| UAT-P02 | API 回應 | < 500ms (p95) | 壓力測試 |
| UAT-P03 | 頁面載入 | < 3 秒 | Lighthouse |

### 8.3 準確率驗收

| 編號 | 驗收項目 | 驗收標準 | 驗證方法 |
|------|---------|---------|---------|
| UAT-A01 | 分段邊界準確率 | > 85% | 人工標註比對 |
| UAT-A02 | 分段類型準確率 | > 80% | 人工標註比對 |
| UAT-A03 | 週期時間誤差 | < 1.0 秒 | 人工計時比對 |

---

## 9. 附錄

### 9.1 術語表

| 術語 | 說明 |
|------|------|
| VisionAI Edge | 研華邊緣 AI 運算設備 |
| YOLO | You Only Look Once，即時物件偵測演算法 |
| 週期時間 | Cycle Time，完成一次製程所需時間 |
| 分段 | 製程中的一個動作階段 |
| IoTSuite | 研華 WISE-IoTSuite 數據中台 |
| DataInsight | 研華數據交換與 ETL 服務 |

### 9.2 參考文件

| 文件名稱 | 文件編號 |
|---------|---------|
| POC 報告 | SMAI-POC-2024-001 |
| 設備介面規格 | SMAI-IFS-2024-001 |
| UAT 測試案例 | SMAI-UAT-2024-001 |

---

## 簽核

| 角色 | 姓名 | 簽名 | 日期 |
|------|------|------|------|
| 撰寫人 | | | |
| 審核人 | | | |
| 核准人 | | | |
