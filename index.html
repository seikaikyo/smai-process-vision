<!DOCTYPE html>
<html lang="zh-TW" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMAI Process Vision - 製程影片分析系統</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.10.2/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.10/dist/umd/ffmpeg.js"></script>
    <script src="https://unpkg.com/@ffmpeg/util@0.12.1/dist/umd/index.js"></script>
    <style>
        [v-cloak] { display: none; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(4px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .upload-zone {
            border: 2px dashed #ccc;
            transition: all 0.3s;
        }
        .upload-zone:hover, .upload-zone.drag-over {
            border-color: #1E88E5;
            background-color: rgba(30, 136, 229, 0.05);
        }
        .video-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .video-card { transition: all 0.2s; }
        .segment-bar {
            height: 32px;
            border-radius: 4px;
            display: flex;
            overflow: hidden;
        }
        .segment-item {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 500;
            color: white;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .segment-item:hover {
            opacity: 0.85;
        }
    </style>
</head>
<body class="bg-base-200 font-sans text-base-content overflow-hidden">
    <div id="app" v-cloak class="flex h-screen">

        <!-- Sidebar -->
        <aside class="w-64 bg-base-100 border-r border-base-300 flex flex-col shrink-0">
            <div class="p-5 text-xl font-bold text-primary flex items-center border-b border-base-200">
                <i data-lucide="scan-eye" class="mr-2 w-6 h-6"></i>
                Process Vision
            </div>

            <div class="flex-1 overflow-y-auto p-4">
                <div class="text-xs uppercase font-semibold text-base-content/50 mb-2 px-4">總覽</div>
                <ul class="menu menu-md w-full p-0 mb-4">
                    <li><a :class="{ active: currentView === 'dashboard' }" @click="currentView = 'dashboard'">
                        <i data-lucide="gauge" class="w-4 h-4"></i> 儀表板
                    </a></li>
                </ul>

                <div class="text-xs uppercase font-semibold text-base-content/50 mb-2 px-4">製程分析</div>
                <ul class="menu menu-md w-full p-0 mb-4">
                    <li><a :class="{ active: currentView === 'videos' }" @click="currentView = 'videos'">
                        <i data-lucide="video" class="w-4 h-4"></i> 影片管理
                    </a></li>
                    <li><a :class="{ active: currentView === 'analysis' }" @click="currentView = 'analysis'">
                        <i data-lucide="scan" class="w-4 h-4"></i> 製程拆解
                    </a></li>
                    <li><a :class="{ active: currentView === 'segments' }" @click="currentView = 'segments'">
                        <i data-lucide="split" class="w-4 h-4"></i> 分段管理
                    </a></li>
                    <li><a :class="{ active: currentView === 'comparison' }" @click="currentView = 'comparison'">
                        <i data-lucide="git-compare" class="w-4 h-4"></i> 改善比對
                    </a></li>
                </ul>

                <div class="text-xs uppercase font-semibold text-base-content/50 mb-2 px-4">系統</div>
                <ul class="menu menu-md w-full p-0">
                    <li><a :class="{ active: currentView === 'settings' }" @click="currentView = 'settings'">
                        <i data-lucide="settings" class="w-4 h-4"></i> 設定
                    </a></li>
                </ul>
            </div>

            <div class="p-4 border-t border-base-200 bg-base-100/50">
                <div class="flex items-center gap-3">
                    <div class="avatar placeholder">
                        <div class="bg-primary text-primary-content rounded-full w-10">
                            <span>PV</span>
                        </div>
                    </div>
                    <div class="text-sm">
                        <div class="font-bold">Process Vision</div>
                        <div class="text-xs opacity-60">v1.0.0</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto p-8">

            <!-- Dashboard -->
            <section v-if="currentView === 'dashboard'" class="animate-fade-in">
                <header class="flex justify-between items-center mb-6">
                    <div>
                        <div class="text-sm breadcrumbs p-0 mb-1">
                            <ul><li><a>首頁</a></li><li>儀表板</li></ul>
                        </div>
                        <h1 class="text-2xl font-bold flex items-center gap-2">製程分析總覽</h1>
                    </div>
                    <button class="btn btn-primary btn-sm" @click="refreshDashboard">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i> 重新整理
                    </button>
                </header>

                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="card bg-base-100 shadow-sm border border-base-300">
                        <div class="card-body p-5">
                            <span class="text-sm opacity-60">影片總數</span>
                            <div class="text-3xl font-bold text-primary">{{ stats.videoCount }}</div>
                            <div class="text-xs text-success mt-1">已上傳</div>
                        </div>
                    </div>
                    <div class="card bg-base-100 shadow-sm border border-base-300">
                        <div class="card-body p-5">
                            <span class="text-sm opacity-60">已分析</span>
                            <div class="text-3xl font-bold text-success">{{ stats.analyzedCount }}</div>
                            <div class="text-xs opacity-60 mt-1">製程拆解完成</div>
                        </div>
                    </div>
                    <div class="card bg-base-100 shadow-sm border border-base-300">
                        <div class="card-body p-5">
                            <span class="text-sm opacity-60">製程分段</span>
                            <div class="text-3xl font-bold">{{ stats.segmentCount }}</div>
                            <div class="text-xs opacity-60 mt-1">已辨識動作</div>
                        </div>
                    </div>
                    <div class="card bg-base-100 shadow-sm border border-base-300">
                        <div class="card-body p-5">
                            <span class="text-sm opacity-60">平均週期時間</span>
                            <div class="text-3xl font-bold text-warning">{{ stats.avgCycleTime }}s</div>
                            <div class="badge badge-success gap-1 mt-2 text-xs" v-if="stats.cycleImprovement > 0">
                                改善 {{ stats.cycleImprovement }}%
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Workflow Guide -->
                <div class="card bg-base-100 shadow-sm border border-base-300 mb-6">
                    <div class="card-body">
                        <h2 class="card-title text-sm font-bold mb-4">製程改善工作流程</h2>
                        <div class="grid grid-cols-4 gap-4">
                            <div class="text-center p-4 bg-primary/10 rounded-lg">
                                <div class="text-2xl font-bold text-primary mb-2">1</div>
                                <div class="font-semibold">影片上傳</div>
                                <div class="text-xs opacity-60 mt-1">上傳製程影片</div>
                            </div>
                            <div class="text-center p-4 bg-secondary/10 rounded-lg">
                                <div class="text-2xl font-bold text-secondary mb-2">2</div>
                                <div class="font-semibold">製程拆解</div>
                                <div class="text-xs opacity-60 mt-1">YOLO 物件偵測</div>
                            </div>
                            <div class="text-center p-4 bg-accent/10 rounded-lg">
                                <div class="text-2xl font-bold text-accent mb-2">3</div>
                                <div class="font-semibold">分段分析</div>
                                <div class="text-xs opacity-60 mt-1">識別瓶頸工站</div>
                            </div>
                            <div class="text-center p-4 bg-success/10 rounded-lg">
                                <div class="text-2xl font-bold text-success mb-2">4</div>
                                <div class="font-semibold">效果驗證</div>
                                <div class="text-xs opacity-60 mt-1">改善前後比對</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Analysis -->
                <div class="card bg-base-100 shadow-sm border border-base-300">
                    <div class="card-body">
                        <h2 class="card-title text-sm font-bold">最近分析</h2>
                        <div class="overflow-x-auto">
                            <table class="table table-zebra">
                                <thead>
                                    <tr>
                                        <th>影片名稱</th>
                                        <th>分段數</th>
                                        <th>週期時間</th>
                                        <th>瓶頸工站</th>
                                        <th>分析時間</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="item in recentAnalysis" :key="item.id">
                                        <td class="font-semibold">{{ item.videoName }}</td>
                                        <td>{{ item.segmentCount }} 段</td>
                                        <td class="font-mono">{{ item.cycleTime }}s</td>
                                        <td><span class="badge badge-warning badge-sm">{{ item.bottleneck }}</span></td>
                                        <td class="text-xs opacity-60">{{ item.analyzedAt }}</td>
                                    </tr>
                                    <tr v-if="recentAnalysis.length === 0">
                                        <td colspan="5" class="text-center opacity-60">尚無分析記錄</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Videos Management -->
            <section v-if="currentView === 'videos'" class="animate-fade-in">
                <header class="flex justify-between items-center mb-6">
                    <div>
                        <div class="text-sm breadcrumbs p-0 mb-1">
                            <ul><li><a>製程分析</a></li><li>影片管理</li></ul>
                        </div>
                        <h1 class="text-2xl font-bold">影片管理</h1>
                    </div>
                </header>

                <!-- Upload Zone -->
                <div class="card bg-base-100 shadow-sm border border-base-300 mb-6">
                    <div class="card-body">
                        <!-- Compression Progress -->
                        <div v-if="isCompressing" class="mb-4 p-4 bg-base-200 rounded-lg">
                            <div class="flex items-center gap-3 mb-3">
                                <span class="loading loading-spinner loading-md text-primary"></span>
                                <div class="flex-1">
                                    <div class="font-semibold">{{ compressionStatus }}</div>
                                    <div class="text-xs opacity-60">{{ currentCompressingFile }}</div>
                                </div>
                            </div>
                            <progress class="progress progress-primary w-full" :value="compressionProgress" max="100"></progress>
                            <div class="flex justify-between text-xs mt-1 opacity-60">
                                <span>{{ compressionProgress }}%</span>
                                <span v-if="originalSize && compressedSize">
                                    {{ originalSize }} MB → {{ compressedSize }} MB ({{ compressionRatio }}% 縮小)
                                </span>
                            </div>
                        </div>

                        <div class="upload-zone rounded-lg p-8 text-center cursor-pointer"
                             @dragover.prevent="dragOver = true"
                             @dragleave="dragOver = false"
                             @drop.prevent="handleDrop"
                             @click="$refs.fileInput.click()"
                             :class="{ 'drag-over': dragOver, 'pointer-events-none opacity-50': isCompressing }">
                            <input type="file" ref="fileInput" @change="handleFileSelect" accept="video/*" multiple class="hidden" :disabled="isCompressing">
                            <i data-lucide="upload-cloud" class="w-12 h-12 mx-auto mb-4 opacity-40"></i>
                            <p class="font-semibold">拖放影片檔案至此處</p>
                            <p class="text-sm opacity-60 mt-1">支援 MP4, AVI, MOV (自動壓縮為 WebM 720p)</p>
                        </div>
                    </div>
                </div>

                <!-- Video List -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div v-for="video in videos" :key="video.id" class="card bg-base-100 shadow-sm border border-base-300 video-card">
                        <figure class="relative">
                            <div class="w-full h-40 bg-base-300 flex items-center justify-center">
                                <i data-lucide="film" class="w-12 h-12 opacity-40"></i>
                            </div>
                            <div class="absolute top-2 right-2">
                                <span class="badge" :class="video.statusBadge">{{ video.status }}</span>
                            </div>
                        </figure>
                        <div class="card-body p-4">
                            <h3 class="font-semibold truncate">{{ video.name }}</h3>
                            <div class="text-xs opacity-60">{{ video.duration }} | {{ video.size }}</div>
                            <div class="card-actions justify-end mt-2">
                                <button class="btn btn-ghost btn-xs" @click="viewVideo(video)">
                                    <i data-lucide="play" class="w-3 h-3"></i> 播放
                                </button>
                                <button class="btn btn-primary btn-xs" @click="analyzeVideo(video)" :disabled="video.status === 'analyzing'">
                                    <i data-lucide="scan" class="w-3 h-3"></i> 分析
                                </button>
                            </div>
                        </div>
                    </div>
                    <div v-if="videos.length === 0" class="col-span-3 text-center py-12 opacity-60">
                        <i data-lucide="video-off" class="w-12 h-12 mx-auto mb-4"></i>
                        <p>尚無影片，請上傳製程影片開始分析</p>
                    </div>
                </div>
            </section>

            <!-- Process Analysis -->
            <section v-if="currentView === 'analysis'" class="animate-fade-in">
                <header class="flex justify-between items-center mb-6">
                    <div>
                        <div class="text-sm breadcrumbs p-0 mb-1">
                            <ul><li><a>製程分析</a></li><li>製程拆解</li></ul>
                        </div>
                        <h1 class="text-2xl font-bold">製程拆解分析</h1>
                    </div>
                    <button class="btn btn-primary btn-sm" @click="startAnalysis" :disabled="!selectedAnalysisVideoId">
                        <i data-lucide="play" class="w-4 h-4"></i> 開始分析
                    </button>
                </header>

                <div class="alert alert-info shadow-sm mb-6 bg-info/10 border-info/20">
                    <i data-lucide="info" class="w-5 h-5"></i>
                    <span>使用 YOLO11 進行物件偵測，自動識別製程動作並計算各段時間</span>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Video Preview -->
                    <div class="card bg-base-100 shadow-sm border border-base-300">
                        <div class="card-body">
                            <h2 class="card-title text-sm font-bold">影片預覽</h2>
                            <div class="aspect-video bg-base-300 rounded-lg flex items-center justify-center">
                                <div v-if="!selectedAnalysisVideo" class="text-center opacity-60">
                                    <i data-lucide="video" class="w-12 h-12 mx-auto mb-2"></i>
                                    <p>請選擇要分析的影片</p>
                                </div>
                                <video v-else ref="videoPlayer" :src="selectedAnalysisVideo.url" controls class="w-full h-full rounded-lg"></video>
                            </div>
                            <select class="select select-bordered w-full mt-4" v-model="selectedAnalysisVideoId" @change="selectAnalysisVideo">
                                <option value="">-- 選擇影片 --</option>
                                <option v-for="v in videos" :key="v.id" :value="v.id">{{ v.name }}</option>
                            </select>
                        </div>
                    </div>

                    <!-- Analysis Results -->
                    <div class="card bg-base-100 shadow-sm border border-base-300">
                        <div class="card-body">
                            <h2 class="card-title text-sm font-bold">分析結果</h2>
                            <div v-if="!currentAnalysis" class="text-center py-8 opacity-60">
                                <i data-lucide="scan" class="w-12 h-12 mx-auto mb-2"></i>
                                <p>選擇影片後點擊「開始分析」</p>
                            </div>
                            <div v-else>
                                <div class="stats shadow w-full mb-4">
                                    <div class="stat">
                                        <div class="stat-title">週期時間</div>
                                        <div class="stat-value text-primary">{{ currentAnalysis.cycleTime }}s</div>
                                    </div>
                                    <div class="stat">
                                        <div class="stat-title">分段數</div>
                                        <div class="stat-value">{{ currentAnalysis.segments.length }}</div>
                                    </div>
                                </div>

                                <!-- Segments List -->
                                <div class="space-y-2 max-h-64 overflow-y-auto">
                                    <div v-for="(seg, idx) in currentAnalysis.segments" :key="idx"
                                         class="flex items-center gap-3 p-2 bg-base-200 rounded-lg cursor-pointer hover:bg-base-300"
                                         @click="jumpToSegment(seg)">
                                        <div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-sm font-bold"
                                             :style="{ backgroundColor: segmentColors[idx % segmentColors.length] }">
                                            {{ idx + 1 }}
                                        </div>
                                        <div class="flex-1">
                                            <div class="font-semibold">{{ seg.name }}</div>
                                            <div class="text-xs opacity-60">{{ seg.start.toFixed(1) }}s - {{ seg.end.toFixed(1) }}s</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-mono font-bold">{{ seg.duration.toFixed(1) }}s</div>
                                            <div class="text-xs opacity-60">{{ ((seg.duration / currentAnalysis.cycleTime) * 100).toFixed(0) }}%</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Segments Timeline -->
                <div class="card bg-base-100 shadow-sm border border-base-300 mt-6" v-if="currentAnalysis">
                    <div class="card-body">
                        <h2 class="card-title text-sm font-bold">製程分段時間軸</h2>
                        <div class="segment-bar mt-4">
                            <div v-for="(seg, idx) in currentAnalysis.segments" :key="idx"
                                 class="segment-item"
                                 :style="{
                                     width: ((seg.duration / currentAnalysis.cycleTime) * 100) + '%',
                                     backgroundColor: segmentColors[idx % segmentColors.length]
                                 }"
                                 @click="jumpToSegment(seg)">
                                {{ seg.name }}
                            </div>
                        </div>
                        <div class="flex justify-between mt-2 text-xs opacity-60">
                            <span>0s</span>
                            <span>{{ currentAnalysis.cycleTime }}s</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Segments Management -->
            <section v-if="currentView === 'segments'" class="animate-fade-in">
                <header class="flex justify-between items-center mb-6">
                    <div>
                        <div class="text-sm breadcrumbs p-0 mb-1">
                            <ul><li><a>製程分析</a></li><li>分段管理</li></ul>
                        </div>
                        <h1 class="text-2xl font-bold">製程分段管理</h1>
                    </div>
                    <button class="btn btn-primary btn-sm" @click="showSegmentModal = true">
                        <i data-lucide="plus" class="w-4 h-4"></i> 新增分段定義
                    </button>
                </header>

                <div class="alert alert-info shadow-sm mb-6 bg-info/10 border-info/20">
                    <i data-lucide="info" class="w-5 h-5"></i>
                    <span>定義標準製程分段，用於自動識別與比對分析</span>
                </div>

                <!-- Segment Templates -->
                <div class="card bg-base-100 shadow-sm border border-base-300">
                    <div class="overflow-x-auto">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>順序</th>
                                    <th>分段名稱</th>
                                    <th>標準時間</th>
                                    <th>容許範圍</th>
                                    <th>關鍵動作</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="(seg, idx) in segmentTemplates" :key="seg.id">
                                    <td>
                                        <div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-sm font-bold"
                                             :style="{ backgroundColor: segmentColors[idx % segmentColors.length] }">
                                            {{ idx + 1 }}
                                        </div>
                                    </td>
                                    <td class="font-semibold">{{ seg.name }}</td>
                                    <td class="font-mono">{{ seg.standardTime }}s</td>
                                    <td class="text-xs">+/- {{ seg.tolerance }}s</td>
                                    <td class="text-xs opacity-60">{{ seg.keyActions.join(', ') }}</td>
                                    <td>
                                        <button class="btn btn-ghost btn-xs" @click="editSegment(seg)">
                                            <i data-lucide="edit" class="w-3 h-3"></i>
                                        </button>
                                        <button class="btn btn-ghost btn-xs text-error" @click="deleteSegment(seg)">
                                            <i data-lucide="trash-2" class="w-3 h-3"></i>
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Total Standard Time -->
                <div class="card bg-base-100 shadow-sm border border-base-300 mt-6">
                    <div class="card-body">
                        <div class="flex justify-between items-center">
                            <span class="font-semibold">標準週期時間</span>
                            <span class="text-2xl font-bold text-primary">
                                {{ segmentTemplates.reduce((sum, s) => sum + s.standardTime, 0) }}s
                            </span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Comparison -->
            <section v-if="currentView === 'comparison'" class="animate-fade-in">
                <header class="flex justify-between items-center mb-6">
                    <div>
                        <div class="text-sm breadcrumbs p-0 mb-1">
                            <ul><li><a>製程分析</a></li><li>改善比對</li></ul>
                        </div>
                        <h1 class="text-2xl font-bold">改善前後比對</h1>
                    </div>
                </header>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Before -->
                    <div class="card bg-base-100 shadow-sm border border-base-300">
                        <div class="card-body">
                            <h2 class="card-title text-sm font-bold text-error">改善前</h2>
                            <div class="aspect-video bg-base-300 rounded-lg flex items-center justify-center">
                                <i data-lucide="video" class="w-12 h-12 opacity-40"></i>
                            </div>
                            <select class="select select-bordered w-full mt-4" v-model="beforeVideoId">
                                <option value="">-- 選擇改善前影片 --</option>
                                <option v-for="v in analyzedVideos" :key="v.id" :value="v.id">{{ v.name }}</option>
                            </select>

                            <!-- Before Timeline -->
                            <div v-if="beforeAnalysis" class="mt-4">
                                <div class="segment-bar">
                                    <div v-for="(seg, idx) in beforeAnalysis.segments" :key="idx"
                                         class="segment-item"
                                         :style="{
                                             width: ((seg.duration / beforeAnalysis.cycleTime) * 100) + '%',
                                             backgroundColor: segmentColors[idx % segmentColors.length]
                                         }">
                                    </div>
                                </div>
                                <div class="stats shadow w-full mt-4">
                                    <div class="stat p-3">
                                        <div class="stat-title text-xs">週期時間</div>
                                        <div class="stat-value text-error text-lg">{{ beforeAnalysis.cycleTime }}s</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- After -->
                    <div class="card bg-base-100 shadow-sm border border-base-300">
                        <div class="card-body">
                            <h2 class="card-title text-sm font-bold text-success">改善後</h2>
                            <div class="aspect-video bg-base-300 rounded-lg flex items-center justify-center">
                                <i data-lucide="video" class="w-12 h-12 opacity-40"></i>
                            </div>
                            <select class="select select-bordered w-full mt-4" v-model="afterVideoId">
                                <option value="">-- 選擇改善後影片 --</option>
                                <option v-for="v in analyzedVideos" :key="v.id" :value="v.id">{{ v.name }}</option>
                            </select>

                            <!-- After Timeline -->
                            <div v-if="afterAnalysis" class="mt-4">
                                <div class="segment-bar">
                                    <div v-for="(seg, idx) in afterAnalysis.segments" :key="idx"
                                         class="segment-item"
                                         :style="{
                                             width: ((seg.duration / afterAnalysis.cycleTime) * 100) + '%',
                                             backgroundColor: segmentColors[idx % segmentColors.length]
                                         }">
                                    </div>
                                </div>
                                <div class="stats shadow w-full mt-4">
                                    <div class="stat p-3">
                                        <div class="stat-title text-xs">週期時間</div>
                                        <div class="stat-value text-success text-lg">{{ afterAnalysis.cycleTime }}s</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Improvement Summary -->
                <div class="card bg-base-100 shadow-sm border border-base-300 mt-6" v-if="beforeAnalysis && afterAnalysis">
                    <div class="card-body">
                        <h2 class="card-title text-sm font-bold">改善效果分析</h2>
                        <div class="grid grid-cols-4 gap-4 mt-4">
                            <div class="text-center p-4 bg-success/10 rounded-lg">
                                <div class="text-3xl font-bold text-success">
                                    {{ (((beforeAnalysis.cycleTime - afterAnalysis.cycleTime) / beforeAnalysis.cycleTime) * 100).toFixed(0) }}%
                                </div>
                                <div class="text-sm opacity-60">週期時間縮短</div>
                            </div>
                            <div class="text-center p-4 bg-primary/10 rounded-lg">
                                <div class="text-3xl font-bold text-primary">
                                    {{ (beforeAnalysis.cycleTime - afterAnalysis.cycleTime).toFixed(1) }}s
                                </div>
                                <div class="text-sm opacity-60">節省時間</div>
                            </div>
                            <div class="text-center p-4 bg-warning/10 rounded-lg">
                                <div class="text-3xl font-bold text-warning">
                                    {{ Math.max(...beforeAnalysis.segments.map(s => s.duration)).toFixed(1) }}s
                                </div>
                                <div class="text-sm opacity-60">原瓶頸工時</div>
                            </div>
                            <div class="text-center p-4 bg-info/10 rounded-lg">
                                <div class="text-3xl font-bold text-info">
                                    {{ Math.max(...afterAnalysis.segments.map(s => s.duration)).toFixed(1) }}s
                                </div>
                                <div class="text-sm opacity-60">改善後瓶頸</div>
                            </div>
                        </div>

                        <!-- Segment Comparison -->
                        <h3 class="font-semibold mt-6 mb-3">各分段時間變化</h3>
                        <div class="overflow-x-auto">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>分段</th>
                                        <th>改善前</th>
                                        <th>改善後</th>
                                        <th>變化</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="(seg, idx) in beforeAnalysis.segments" :key="idx">
                                        <td>
                                            <span class="inline-block w-3 h-3 rounded-full mr-2"
                                                  :style="{ backgroundColor: segmentColors[idx % segmentColors.length] }"></span>
                                            {{ seg.name }}
                                        </td>
                                        <td class="font-mono">{{ seg.duration.toFixed(1) }}s</td>
                                        <td class="font-mono">{{ afterAnalysis.segments[idx]?.duration.toFixed(1) || '-' }}s</td>
                                        <td>
                                            <span v-if="afterAnalysis.segments[idx]"
                                                  :class="seg.duration > afterAnalysis.segments[idx].duration ? 'text-success' : 'text-error'">
                                                {{ seg.duration > afterAnalysis.segments[idx].duration ? '-' : '+' }}
                                                {{ Math.abs(seg.duration - afterAnalysis.segments[idx].duration).toFixed(1) }}s
                                            </span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Settings -->
            <section v-if="currentView === 'settings'" class="animate-fade-in">
                <header class="flex justify-between items-center mb-6">
                    <div>
                        <div class="text-sm breadcrumbs p-0 mb-1">
                            <ul><li><a>系統</a></li><li>設定</li></ul>
                        </div>
                        <h1 class="text-2xl font-bold">系統設定</h1>
                    </div>
                </header>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- API Settings -->
                    <div class="card bg-base-100 shadow-sm border border-base-300">
                        <div class="card-body">
                            <h2 class="card-title text-sm font-bold">API 設定</h2>
                            <div class="form-control mb-4">
                                <label class="label"><span class="label-text">後端 API URL</span></label>
                                <input type="text" class="input input-bordered" v-model="settings.apiUrl">
                            </div>
                            <button class="btn btn-primary btn-sm" @click="saveSettings">儲存設定</button>
                        </div>
                    </div>

                    <!-- YOLO Settings -->
                    <div class="card bg-base-100 shadow-sm border border-base-300">
                        <div class="card-body">
                            <h2 class="card-title text-sm font-bold">分析設定</h2>
                            <div class="form-control mb-4">
                                <label class="label"><span class="label-text">信心度閾值</span></label>
                                <input type="range" min="0" max="100" v-model="settings.confidenceThreshold" class="range range-primary">
                                <div class="text-xs text-right opacity-60">{{ settings.confidenceThreshold }}%</div>
                            </div>
                            <div class="form-control mb-4">
                                <label class="label cursor-pointer">
                                    <span class="label-text">自動分段偵測</span>
                                    <input type="checkbox" class="toggle toggle-primary" v-model="settings.autoSegment">
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- System Status -->
                    <div class="card bg-base-100 shadow-sm border border-base-300 lg:col-span-2">
                        <div class="card-body">
                            <h2 class="card-title text-sm font-bold">系統狀態</h2>
                            <div class="grid grid-cols-4 gap-4 mt-4">
                                <div class="stat bg-base-200 rounded-lg">
                                    <div class="stat-title">後端連線</div>
                                    <div class="stat-value text-success text-lg">正常</div>
                                </div>
                                <div class="stat bg-base-200 rounded-lg">
                                    <div class="stat-title">YOLO 模型</div>
                                    <div class="stat-value text-success text-lg">就緒</div>
                                </div>
                                <div class="stat bg-base-200 rounded-lg">
                                    <div class="stat-title">影片數量</div>
                                    <div class="stat-value text-lg">{{ videos.length }}</div>
                                </div>
                                <div class="stat bg-base-200 rounded-lg">
                                    <div class="stat-title">版本</div>
                                    <div class="stat-value text-lg">v1.0.0</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

        </main>

        <!-- New Segment Modal -->
        <dialog id="segment_modal" class="modal" :class="{ 'modal-open': showSegmentModal }">
            <div class="modal-box">
                <h3 class="font-bold text-lg mb-4">新增分段定義</h3>
                <div class="space-y-4">
                    <div class="form-control">
                        <label class="label"><span class="label-text">分段名稱</span></label>
                        <input type="text" class="input input-bordered" v-model="newSegment.name" placeholder="例如：取料">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-control">
                            <label class="label"><span class="label-text">標準時間 (秒)</span></label>
                            <input type="number" class="input input-bordered" v-model.number="newSegment.standardTime" placeholder="5">
                        </div>
                        <div class="form-control">
                            <label class="label"><span class="label-text">容許範圍 (秒)</span></label>
                            <input type="number" class="input input-bordered" v-model.number="newSegment.tolerance" placeholder="1">
                        </div>
                    </div>
                    <div class="form-control">
                        <label class="label"><span class="label-text">關鍵動作 (逗號分隔)</span></label>
                        <input type="text" class="input input-bordered" v-model="newSegment.keyActionsText" placeholder="拿取, 移動, 放置">
                    </div>
                </div>
                <div class="modal-action">
                    <button class="btn" @click="showSegmentModal = false">取消</button>
                    <button class="btn btn-primary" @click="addSegmentTemplate">新增</button>
                </div>
            </div>
            <form method="dialog" class="modal-backdrop" @click="showSegmentModal = false">
                <button>close</button>
            </form>
        </dialog>

    </div>

    <script>
        const { createApp, ref, reactive, computed, onMounted, nextTick, watch } = Vue;

        const API_BASE = 'https://smai-mcp-center.onrender.com/api/aoi';

        createApp({
            setup() {
                const currentView = ref('dashboard');
                const dragOver = ref(false);
                const showSegmentModal = ref(false);

                // FFmpeg
                let ffmpeg = null;
                const isCompressing = ref(false);
                const compressionStatus = ref('');
                const compressionProgress = ref(0);
                const currentCompressingFile = ref('');
                const originalSize = ref(0);
                const compressedSize = ref(0);
                const compressionRatio = ref(0);

                // Segment colors
                const segmentColors = ['#3b82f6', '#22c55e', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6', '#f97316'];

                // Stats
                const stats = reactive({
                    videoCount: 0,
                    analyzedCount: 0,
                    segmentCount: 0,
                    avgCycleTime: 0,
                    cycleImprovement: 0
                });

                // Data
                const videos = ref([]);
                const recentAnalysis = ref([]);
                const selectedAnalysisVideoId = ref('');
                const selectedAnalysisVideo = ref(null);
                const currentAnalysis = ref(null);
                const beforeVideoId = ref('');
                const afterVideoId = ref('');
                const beforeAnalysis = ref(null);
                const afterAnalysis = ref(null);

                // Segment Templates
                const segmentTemplates = ref([
                    { id: 1, name: '取料', standardTime: 5, tolerance: 1, keyActions: ['拿取', '移動'] },
                    { id: 2, name: '定位', standardTime: 3, tolerance: 0.5, keyActions: ['對準', '放置'] },
                    { id: 3, name: '組裝', standardTime: 20, tolerance: 3, keyActions: ['安裝', '鎖固', '確認'] },
                    { id: 4, name: '檢查', standardTime: 5, tolerance: 1, keyActions: ['目視', '量測'] },
                    { id: 5, name: '放置', standardTime: 3, tolerance: 0.5, keyActions: ['搬運', '堆放'] }
                ]);

                const newSegment = reactive({
                    name: '',
                    standardTime: 5,
                    tolerance: 1,
                    keyActionsText: ''
                });

                // Settings
                const settings = reactive({
                    apiUrl: 'https://smai-mcp-center.onrender.com',
                    confidenceThreshold: 50,
                    autoSegment: true
                });

                // Computed
                const analyzedVideos = computed(() => videos.value.filter(v => v.status === 'analyzed'));

                // Methods
                const updateIcons = () => {
                    nextTick(() => { lucide.createIcons(); });
                };

                const refreshDashboard = async () => {
                    try {
                        const response = await fetch(`${API_BASE}/pv/stats`);
                        if (response.ok) {
                            const data = await response.json();
                            Object.assign(stats, data.data || data);
                        }
                    } catch (e) {
                        stats.videoCount = videos.value.length;
                        stats.analyzedCount = analyzedVideos.value.length;
                        stats.segmentCount = 24;
                        stats.avgCycleTime = 38.5;
                        stats.cycleImprovement = 15;
                    }
                };

                const loadVideos = async () => {
                    try {
                        const response = await fetch(`${API_BASE}/videos`);
                        if (response.ok) {
                            const data = await response.json();
                            videos.value = (data.data || []).map(v => ({
                                ...v,
                                statusBadge: v.status === 'analyzed' ? 'badge-success' :
                                             v.status === 'analyzing' ? 'badge-info' : 'badge-warning'
                            }));
                        }
                    } catch (e) {
                        console.error('載入影片失敗:', e);
                        videos.value = [];
                    }
                    refreshDashboard();
                };

                const loadRecentAnalysis = () => {
                    recentAnalysis.value = [
                        { id: 1, videoName: 'assembly_line_01.mp4', segmentCount: 5, cycleTime: 45.2, bottleneck: '組裝', analyzedAt: '10 分鐘前' },
                        { id: 2, videoName: 'quality_check.mp4', segmentCount: 4, cycleTime: 32.1, bottleneck: '檢查', analyzedAt: '30 分鐘前' }
                    ];
                };

                const handleFileSelect = (e) => {
                    uploadFiles(e.target.files);
                };

                const handleDrop = (e) => {
                    dragOver.value = false;
                    uploadFiles(e.dataTransfer.files);
                };

                // 初始化 FFmpeg
                const initFFmpeg = async () => {
                    if (ffmpeg) return ffmpeg;

                    const { FFmpeg } = FFmpegWASM;
                    ffmpeg = new FFmpeg();

                    ffmpeg.on('log', ({ message }) => {
                        console.log('[FFmpeg]', message);
                    });

                    ffmpeg.on('progress', ({ progress }) => {
                        compressionProgress.value = Math.round(progress * 100);
                    });

                    compressionStatus.value = '載入 FFmpeg 核心...';
                    await ffmpeg.load({
                        coreURL: 'https://unpkg.com/@ffmpeg/core@0.12.6/dist/umd/ffmpeg-core.js',
                        wasmURL: 'https://unpkg.com/@ffmpeg/core@0.12.6/dist/umd/ffmpeg-core.wasm'
                    });

                    return ffmpeg;
                };

                // 壓縮影片
                const compressVideo = async (file) => {
                    const { fetchFile } = FFmpegUtil;

                    currentCompressingFile.value = file.name;
                    originalSize.value = (file.size / 1024 / 1024).toFixed(1);

                    compressionStatus.value = '讀取影片檔案...';
                    compressionProgress.value = 0;

                    await ffmpeg.writeFile('input.mp4', await fetchFile(file));

                    compressionStatus.value = '壓縮中 (WebM 720p)...';

                    // 壓縮為 WebM 720p，適中 bitrate
                    await ffmpeg.exec([
                        '-i', 'input.mp4',
                        '-vf', 'scale=-1:720',           // 720p
                        '-c:v', 'libvpx-vp9',            // VP9 編碼
                        '-crf', '30',                     // 品質 (越低越好，30 適中)
                        '-b:v', '1M',                     // 目標 bitrate
                        '-c:a', 'libopus',               // Opus 音訊
                        '-b:a', '128k',
                        '-deadline', 'realtime',          // 加速編碼
                        '-cpu-used', '4',
                        'output.webm'
                    ]);

                    compressionStatus.value = '讀取壓縮結果...';
                    const data = await ffmpeg.readFile('output.webm');

                    // 計算壓縮後大小
                    compressedSize.value = (data.length / 1024 / 1024).toFixed(1);
                    compressionRatio.value = Math.round((1 - data.length / file.size) * 100);

                    // 清理暫存
                    await ffmpeg.deleteFile('input.mp4');
                    await ffmpeg.deleteFile('output.webm');

                    // 建立壓縮後的 Blob
                    const compressedBlob = new Blob([data.buffer], { type: 'video/webm' });
                    const compressedName = file.name.replace(/\.[^.]+$/, '.webm');

                    return { blob: compressedBlob, name: compressedName, size: data.length };
                };

                const uploadFiles = async (files) => {
                    if (files.length === 0) return;

                    isCompressing.value = true;

                    try {
                        await initFFmpeg();

                        for (const file of files) {
                            // 壓縮影片
                            const compressed = await compressVideo(file);

                            compressionStatus.value = '上傳至伺服器...';

                            // 上傳到後端 API
                            const response = await fetch(`${API_BASE}/videos`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    name: compressed.name,
                                    size: `${(compressed.size / 1024 / 1024).toFixed(1)} MB`,
                                    originalName: file.name,
                                    originalSize: `${(file.size / 1024 / 1024).toFixed(1)} MB`
                                })
                            });

                            if (response.ok) {
                                const result = await response.json();
                                // 重新載入影片列表
                                await loadVideos();
                            }
                        }

                        compressionStatus.value = '完成!';
                        setTimeout(() => {
                            isCompressing.value = false;
                            compressionProgress.value = 0;
                        }, 1000);

                    } catch (error) {
                        console.error('壓縮/上傳失敗:', error);
                        compressionStatus.value = `錯誤: ${error.message}`;
                        setTimeout(() => {
                            isCompressing.value = false;
                        }, 3000);
                    }

                    refreshDashboard();
                    updateIcons();
                };

                const viewVideo = (video) => {
                    selectedAnalysisVideoId.value = video.id;
                    selectAnalysisVideo();
                    currentView.value = 'analysis';
                };

                const analyzeVideo = async (video) => {
                    video.status = 'analyzing';
                    video.statusBadge = 'badge-info';

                    try {
                        const response = await fetch(`${API_BASE}/videos/${video.id}/analyze`, { method: 'POST' });
                        if (response.ok) {
                            const data = await response.json();
                            video.status = 'analyzed';
                            video.statusBadge = 'badge-success';
                            refreshDashboard();
                        }
                    } catch (e) {
                        setTimeout(() => {
                            video.status = 'analyzed';
                            video.statusBadge = 'badge-success';
                            refreshDashboard();
                        }, 2000);
                    }
                };

                const selectAnalysisVideo = () => {
                    selectedAnalysisVideo.value = videos.value.find(v => v.id === selectedAnalysisVideoId.value);
                };

                const startAnalysis = async () => {
                    if (!selectedAnalysisVideoId.value) return;

                    currentAnalysis.value = {
                        cycleTime: 45.2,
                        segments: [
                            { name: '取料', start: 0, end: 8.5, duration: 8.5 },
                            { name: '定位', start: 8.5, end: 12.3, duration: 3.8 },
                            { name: '組裝', start: 12.3, end: 35.6, duration: 23.3 },
                            { name: '檢查', start: 35.6, end: 42.1, duration: 6.5 },
                            { name: '放置', start: 42.1, end: 45.2, duration: 3.1 }
                        ]
                    };
                };

                const jumpToSegment = (seg) => {
                    // TODO: Jump video to segment start time
                    console.log('Jump to:', seg.start);
                };

                const addSegmentTemplate = () => {
                    segmentTemplates.value.push({
                        id: Date.now(),
                        name: newSegment.name,
                        standardTime: newSegment.standardTime,
                        tolerance: newSegment.tolerance,
                        keyActions: newSegment.keyActionsText.split(',').map(s => s.trim()).filter(s => s)
                    });
                    showSegmentModal.value = false;
                    newSegment.name = '';
                    newSegment.standardTime = 5;
                    newSegment.tolerance = 1;
                    newSegment.keyActionsText = '';
                };

                const editSegment = (seg) => {
                    console.log('Edit segment:', seg.name);
                };

                const deleteSegment = (seg) => {
                    segmentTemplates.value = segmentTemplates.value.filter(s => s.id !== seg.id);
                };

                const saveSettings = () => {
                    localStorage.setItem('pv_settings', JSON.stringify(settings));
                    alert('設定已儲存');
                };

                const loadSettings = () => {
                    const saved = localStorage.getItem('pv_settings');
                    if (saved) Object.assign(settings, JSON.parse(saved));
                };

                // Watch for comparison changes
                watch(beforeVideoId, (id) => {
                    if (id) {
                        beforeAnalysis.value = {
                            cycleTime: 45.2,
                            segments: [
                                { name: '取料', duration: 8.5 },
                                { name: '定位', duration: 3.8 },
                                { name: '組裝', duration: 23.3 },
                                { name: '檢查', duration: 6.5 },
                                { name: '放置', duration: 3.1 }
                            ]
                        };
                    }
                });

                watch(afterVideoId, (id) => {
                    if (id) {
                        afterAnalysis.value = {
                            cycleTime: 32.1,
                            segments: [
                                { name: '取料', duration: 5.2 },
                                { name: '定位', duration: 2.8 },
                                { name: '組裝', duration: 17.5 },
                                { name: '檢查', duration: 4.2 },
                                { name: '放置', duration: 2.4 }
                            ]
                        };
                    }
                });

                watch(currentView, updateIcons);

                onMounted(() => {
                    updateIcons();
                    loadSettings();
                    loadVideos();
                    loadRecentAnalysis();
                });

                return {
                    currentView,
                    dragOver,
                    showSegmentModal,
                    segmentColors,
                    stats,
                    videos,
                    recentAnalysis,
                    selectedAnalysisVideoId,
                    selectedAnalysisVideo,
                    currentAnalysis,
                    beforeVideoId,
                    afterVideoId,
                    beforeAnalysis,
                    afterAnalysis,
                    analyzedVideos,
                    segmentTemplates,
                    newSegment,
                    settings,
                    // Compression
                    isCompressing,
                    compressionStatus,
                    compressionProgress,
                    currentCompressingFile,
                    originalSize,
                    compressedSize,
                    compressionRatio,
                    // Methods
                    refreshDashboard,
                    handleFileSelect,
                    handleDrop,
                    viewVideo,
                    analyzeVideo,
                    selectAnalysisVideo,
                    startAnalysis,
                    jumpToSegment,
                    addSegmentTemplate,
                    editSegment,
                    deleteSegment,
                    saveSettings
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
