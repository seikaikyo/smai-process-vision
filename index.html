<!DOCTYPE html>
<html lang="zh-TW" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMAI Process Vision - 製程影片分析系統</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.10.2/dist/full.min.css" rel="stylesheet" type="text/css" />
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        [v-cloak] { display: none; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(4px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .upload-zone {
            border: 2px dashed #ccc;
            transition: all 0.3s;
        }
        .upload-zone:hover, .upload-zone.drag-over {
            border-color: #1E88E5;
            background-color: rgba(30, 136, 229, 0.05);
        }
        .video-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .video-card { transition: all 0.2s; }
        .segment-bar {
            height: 32px;
            border-radius: 4px;
            display: flex;
            overflow: hidden;
        }
        .segment-item {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 500;
            color: white;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .segment-item:hover {
            opacity: 0.85;
        }
        /* 拖拉排序樣式 */
        .sortable-ghost {
            opacity: 0.4;
            background: #3b82f6 !important;
        }
        .sortable-drag {
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .drag-handle {
            cursor: grab;
        }
        .drag-handle:active {
            cursor: grabbing;
        }
        /* 時間軸拖拉樣式 */
        .segment-resize-handle {
            position: absolute;
            top: -4px;
            bottom: -4px;
            width: 12px;
            cursor: ew-resize;
            background: rgba(255,255,255,0.4);
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 10;
            border-radius: 2px;
        }
        .segment-resize-handle:hover,
        .segment-resize-handle.active {
            opacity: 1;
            background: rgba(255,255,255,0.8);
        }
        .segment-resize-handle.left { left: -6px; }
        .segment-resize-handle.right { right: -6px; }
        .segment-item:hover .segment-resize-handle {
            opacity: 0.6;
        }
        /* 觸控裝置顯示 handle */
        @media (hover: none) {
            .segment-resize-handle {
                opacity: 0.5;
                width: 16px;
            }
            .segment-resize-handle.right { right: -8px; }
        }
    </style>
</head>
<body class="bg-base-200 font-sans text-base-content overflow-hidden">
    <div id="app" v-cloak class="flex h-screen">

        <!-- Sidebar -->
        <aside class="w-64 bg-base-100 border-r border-base-300 flex flex-col shrink-0">
            <div class="p-5 text-xl font-bold text-primary flex items-center border-b border-base-200">
                <i data-lucide="scan-eye" class="mr-2 w-6 h-6"></i>
                Process Vision
            </div>

            <div class="flex-1 overflow-y-auto p-4">
                <div class="text-xs uppercase font-semibold text-base-content/50 mb-2 px-4">總覽</div>
                <ul class="menu menu-md w-full p-0 mb-4">
                    <li><a :class="{ active: currentView === 'dashboard' }" @click="currentView = 'dashboard'">
                        <i data-lucide="gauge" class="w-4 h-4"></i> 儀表板
                    </a></li>
                </ul>

                <div class="text-xs uppercase font-semibold text-base-content/50 mb-2 px-4">製程分析</div>
                <ul class="menu menu-md w-full p-0 mb-4">
                    <li><a :class="{ active: currentView === 'videos' }" @click="currentView = 'videos'">
                        <i data-lucide="video" class="w-4 h-4"></i> 影片管理
                    </a></li>
                    <li><a :class="{ active: currentView === 'analysis' }" @click="currentView = 'analysis'">
                        <i data-lucide="scan" class="w-4 h-4"></i> 製程拆解
                    </a></li>
                    <li><a :class="{ active: currentView === 'segments' }" @click="currentView = 'segments'">
                        <i data-lucide="split" class="w-4 h-4"></i> 分段管理
                    </a></li>
                    <li><a :class="{ active: currentView === 'comparison' }" @click="currentView = 'comparison'">
                        <i data-lucide="git-compare" class="w-4 h-4"></i> 改善比對
                    </a></li>
                </ul>

                <div class="text-xs uppercase font-semibold text-base-content/50 mb-2 px-4">系統</div>
                <ul class="menu menu-md w-full p-0">
                    <li><a :class="{ active: currentView === 'settings' }" @click="currentView = 'settings'">
                        <i data-lucide="settings" class="w-4 h-4"></i> 設定
                    </a></li>
                </ul>
            </div>

            <div class="p-4 border-t border-base-200 bg-base-100/50">
                <div class="flex items-center gap-3">
                    <div class="avatar placeholder">
                        <div class="bg-primary text-primary-content rounded-full w-10">
                            <span>PV</span>
                        </div>
                    </div>
                    <div class="text-sm">
                        <div class="font-bold">Process Vision</div>
                        <div class="text-xs opacity-60">v1.0.0</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto p-8">

            <!-- Dashboard -->
            <section v-if="currentView === 'dashboard'" class="animate-fade-in">
                <header class="flex justify-between items-center mb-6">
                    <div>
                        <div class="text-sm breadcrumbs p-0 mb-1">
                            <ul><li><a>首頁</a></li><li>儀表板</li></ul>
                        </div>
                        <h1 class="text-2xl font-bold flex items-center gap-2">製程分析總覽</h1>
                    </div>
                    <button class="btn btn-primary btn-sm" @click="refreshDashboard">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i> 重新整理
                    </button>
                </header>

                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="card bg-base-100 shadow-sm border border-base-300">
                        <div class="card-body p-5">
                            <span class="text-sm opacity-60">影片總數</span>
                            <div class="text-3xl font-bold text-primary">{{ stats.videoCount }}</div>
                            <div class="text-xs text-success mt-1">已上傳</div>
                        </div>
                    </div>
                    <div class="card bg-base-100 shadow-sm border border-base-300">
                        <div class="card-body p-5">
                            <span class="text-sm opacity-60">已分析</span>
                            <div class="text-3xl font-bold text-success">{{ stats.analyzedCount }}</div>
                            <div class="text-xs opacity-60 mt-1">製程拆解完成</div>
                        </div>
                    </div>
                    <div class="card bg-base-100 shadow-sm border border-base-300">
                        <div class="card-body p-5">
                            <span class="text-sm opacity-60">製程分段</span>
                            <div class="text-3xl font-bold">{{ stats.segmentCount }}</div>
                            <div class="text-xs opacity-60 mt-1">已辨識動作</div>
                        </div>
                    </div>
                    <div class="card bg-base-100 shadow-sm border border-base-300">
                        <div class="card-body p-5">
                            <span class="text-sm opacity-60">平均週期時間</span>
                            <div class="text-3xl font-bold text-warning">{{ stats.avgCycleTime }}s</div>
                            <div class="badge badge-success gap-1 mt-2 text-xs" v-if="stats.cycleImprovement > 0">
                                改善 {{ stats.cycleImprovement }}%
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Workflow Guide -->
                <div class="card bg-base-100 shadow-sm border border-base-300 mb-6">
                    <div class="card-body">
                        <h2 class="card-title text-sm font-bold mb-4">製程改善工作流程</h2>
                        <div class="grid grid-cols-4 gap-4">
                            <div class="text-center p-4 bg-primary/10 rounded-lg">
                                <div class="text-2xl font-bold text-primary mb-2">1</div>
                                <div class="font-semibold">影片上傳</div>
                                <div class="text-xs opacity-60 mt-1">上傳製程影片</div>
                            </div>
                            <div class="text-center p-4 bg-secondary/10 rounded-lg">
                                <div class="text-2xl font-bold text-secondary mb-2">2</div>
                                <div class="font-semibold">製程拆解</div>
                                <div class="text-xs opacity-60 mt-1">YOLO 物件偵測</div>
                            </div>
                            <div class="text-center p-4 bg-accent/10 rounded-lg">
                                <div class="text-2xl font-bold text-accent mb-2">3</div>
                                <div class="font-semibold">分段分析</div>
                                <div class="text-xs opacity-60 mt-1">識別瓶頸工站</div>
                            </div>
                            <div class="text-center p-4 bg-success/10 rounded-lg">
                                <div class="text-2xl font-bold text-success mb-2">4</div>
                                <div class="font-semibold">效果驗證</div>
                                <div class="text-xs opacity-60 mt-1">改善前後比對</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Analysis -->
                <div class="card bg-base-100 shadow-sm border border-base-300">
                    <div class="card-body">
                        <h2 class="card-title text-sm font-bold">最近分析</h2>
                        <div class="overflow-x-auto">
                            <table class="table table-zebra">
                                <thead>
                                    <tr>
                                        <th>影片名稱</th>
                                        <th>分段數</th>
                                        <th>週期時間</th>
                                        <th>瓶頸工站</th>
                                        <th>分析時間</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="item in recentAnalysis" :key="item.id">
                                        <td class="font-semibold">{{ item.videoName }}</td>
                                        <td>{{ item.segmentCount }} 段</td>
                                        <td class="font-mono">{{ item.cycleTime }}s</td>
                                        <td><span class="badge badge-warning badge-sm">{{ item.bottleneck }}</span></td>
                                        <td class="text-xs opacity-60">{{ item.analyzedAt }}</td>
                                    </tr>
                                    <tr v-if="recentAnalysis.length === 0">
                                        <td colspan="5" class="text-center opacity-60">尚無分析記錄</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Videos Management -->
            <section v-if="currentView === 'videos'" class="animate-fade-in">
                <header class="flex justify-between items-center mb-6">
                    <div>
                        <div class="text-sm breadcrumbs p-0 mb-1">
                            <ul><li><a>製程分析</a></li><li>影片管理</li></ul>
                        </div>
                        <h1 class="text-2xl font-bold">影片管理</h1>
                    </div>
                </header>

                <!-- Upload Zone -->
                <div class="card bg-base-100 shadow-sm border border-base-300 mb-6">
                    <div class="card-body">
                        <!-- Upload Progress -->
                        <div v-if="isUploading" class="mb-4 p-4 bg-base-200 rounded-lg">
                            <div class="flex items-center gap-3 mb-3">
                                <span class="loading loading-spinner loading-md text-primary"></span>
                                <div class="flex-1">
                                    <div class="font-semibold">{{ uploadStatus }}</div>
                                    <div class="text-xs opacity-60">{{ currentUploadingFile }}</div>
                                </div>
                            </div>
                            <progress class="progress progress-primary w-full" :value="uploadProgress" max="100"></progress>
                        </div>

                        <div class="upload-zone rounded-lg p-8 text-center cursor-pointer"
                             @dragover.prevent="dragOver = true"
                             @dragleave="dragOver = false"
                             @drop.prevent="handleDrop"
                             @click="$refs.fileInput.click()"
                             :class="{ 'drag-over': dragOver, 'pointer-events-none opacity-50': isUploading }">
                            <input type="file" ref="fileInput" @change="handleFileSelect" accept="video/*" multiple class="hidden" :disabled="isUploading">
                            <i data-lucide="upload-cloud" class="w-12 h-12 mx-auto mb-4 opacity-40"></i>
                            <p class="font-semibold">拖放影片檔案至此處</p>
                            <p class="text-sm opacity-60 mt-1">支援 MP4, AVI, MOV（單檔最大 100MB）</p>
                        </div>

                        <!-- 壓縮提示 -->
                        <div class="alert mt-4 bg-base-200 border-0">
                            <i data-lucide="info" class="w-4 h-4 shrink-0"></i>
                            <div class="text-sm">
                                <span class="opacity-70">影片超過 100MB？使用壓縮工具：</span>
                                <a href="https://handbrake.fr/" target="_blank" class="link link-primary ml-1">HandBrake</a>
                                <span class="opacity-40 mx-1">|</span>
                                <a href="https://www.freeconvert.com/video-compressor" target="_blank" class="link link-primary">FreeConvert</a>
                                <span class="opacity-40 mx-1">|</span>
                                <a href="https://cloudconvert.com/video-compressor" target="_blank" class="link link-primary">CloudConvert</a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Video List -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div v-for="video in videos" :key="video.id" class="card bg-base-100 shadow-sm border border-base-300 video-card">
                        <figure class="relative">
                            <div class="w-full h-40 bg-base-300 flex items-center justify-center">
                                <i data-lucide="film" class="w-12 h-12 opacity-40"></i>
                            </div>
                            <div class="absolute top-2 right-2">
                                <span class="badge" :class="video.statusBadge">{{ video.status }}</span>
                            </div>
                        </figure>
                        <div class="card-body p-4">
                            <h3 class="font-semibold truncate">{{ video.name }}</h3>
                            <div class="text-xs opacity-60">{{ video.duration }} | {{ video.size }}</div>
                            <div class="card-actions justify-end mt-2">
                                <button class="btn btn-ghost btn-xs" @click="viewVideo(video)">
                                    <i data-lucide="play" class="w-3 h-3"></i> 播放
                                </button>
                                <button class="btn btn-primary btn-xs" @click="analyzeVideo(video)" :disabled="video.status === 'analyzing'">
                                    <i data-lucide="scan" class="w-3 h-3"></i> 分析
                                </button>
                                <button class="btn btn-error btn-xs" @click="deleteVideo(video)">
                                    <i data-lucide="trash-2" class="w-3 h-3"></i> 刪除
                                </button>
                            </div>
                        </div>
                    </div>
                    <div v-if="videos.length === 0" class="col-span-3 text-center py-12 opacity-60">
                        <i data-lucide="video-off" class="w-12 h-12 mx-auto mb-4"></i>
                        <p>尚無影片，請上傳製程影片開始分析</p>
                    </div>
                </div>
            </section>

            <!-- Process Analysis -->
            <section v-if="currentView === 'analysis'" class="animate-fade-in">
                <header class="flex justify-between items-center mb-6">
                    <div>
                        <div class="text-sm breadcrumbs p-0 mb-1">
                            <ul><li><a>製程分析</a></li><li>製程拆解</li></ul>
                        </div>
                        <h1 class="text-2xl font-bold">製程拆解分析</h1>
                    </div>
                    <button class="btn btn-primary btn-sm" @click="startAnalysis" :disabled="!selectedAnalysisVideoId || isAnalyzing">
                        <span v-if="isAnalyzing" class="loading loading-spinner loading-xs"></span>
                        <i v-else data-lucide="play" class="w-4 h-4"></i>
                        {{ isAnalyzing ? '分析中...' : '開始分析' }}
                    </button>
                </header>

                <div class="alert alert-info shadow-sm mb-6 bg-info/10 border-info/20">
                    <i data-lucide="info" class="w-5 h-5"></i>
                    <span>使用 YOLO11 進行物件偵測，自動識別製程動作並計算各段時間</span>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Video Preview -->
                    <div class="card bg-base-100 shadow-sm border border-base-300">
                        <div class="card-body">
                            <h2 class="card-title text-sm font-bold">影片預覽</h2>
                            <div class="aspect-video bg-base-300 rounded-lg flex items-center justify-center">
                                <div v-if="!selectedAnalysisVideo" class="text-center opacity-60">
                                    <i data-lucide="video" class="w-12 h-12 mx-auto mb-2"></i>
                                    <p>請選擇要分析的影片</p>
                                </div>
                                <video v-else ref="videoPlayer" :src="selectedAnalysisVideo.url" controls class="w-full h-full rounded-lg"></video>
                            </div>
                            <select class="select select-bordered w-full mt-4" v-model="selectedAnalysisVideoId" @change="selectAnalysisVideo">
                                <option value="">-- 選擇影片 --</option>
                                <option v-for="v in videos" :key="v.id" :value="v.id">{{ v.name }}</option>
                            </select>
                        </div>
                    </div>

                    <!-- Analysis Results -->
                    <div class="card bg-base-100 shadow-sm border border-base-300">
                        <div class="card-body">
                            <h2 class="card-title text-sm font-bold">分析結果</h2>
                            <div v-if="!currentAnalysis" class="text-center py-8 opacity-60">
                                <i data-lucide="scan" class="w-12 h-12 mx-auto mb-2"></i>
                                <p>選擇影片後點擊「開始分析」</p>
                            </div>
                            <div v-else>
                                <div class="stats shadow w-full mb-4">
                                    <div class="stat">
                                        <div class="stat-title">週期時間</div>
                                        <div class="stat-value text-primary">{{ currentAnalysis.cycleTime }}s</div>
                                    </div>
                                    <div class="stat">
                                        <div class="stat-title">分段數</div>
                                        <div class="stat-value">{{ currentAnalysis.segments.length }}</div>
                                    </div>
                                </div>

                                <!-- Segments List -->
                                <div class="space-y-2 max-h-64 overflow-y-auto">
                                    <div v-for="(seg, idx) in currentAnalysis.segments" :key="idx"
                                         class="flex items-center gap-3 p-2 bg-base-200 rounded-lg cursor-pointer hover:bg-base-300"
                                         @click="jumpToSegment(seg)">
                                        <div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-sm font-bold"
                                             :style="{ backgroundColor: segmentColors[idx % segmentColors.length] }">
                                            {{ idx + 1 }}
                                        </div>
                                        <div class="flex-1">
                                            <div class="font-semibold">{{ seg.name }}</div>
                                            <div class="text-xs opacity-60">{{ seg.start.toFixed(1) }}s - {{ seg.end.toFixed(1) }}s</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-mono font-bold">{{ seg.duration.toFixed(1) }}s</div>
                                            <div class="text-xs opacity-60">{{ ((seg.duration / currentAnalysis.cycleTime) * 100).toFixed(0) }}%</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Segments Timeline -->
                <div class="card bg-base-100 shadow-sm border border-base-300 mt-6" v-if="currentAnalysis">
                    <div class="card-body">
                        <div class="flex justify-between items-center mb-2">
                            <h2 class="card-title text-sm font-bold">製程分段時間軸</h2>
                            <span class="text-xs opacity-60">拖動分段邊界調整時間</span>
                        </div>
                        <div class="segment-bar mt-4" ref="timelineRef">
                            <div v-for="(seg, idx) in currentAnalysis.segments" :key="idx"
                                 class="segment-item relative"
                                 :style="{
                                     width: ((seg.duration / currentAnalysis.cycleTime) * 100) + '%',
                                     backgroundColor: segmentColors[idx % segmentColors.length]
                                 }"
                                 @click="jumpToSegment(seg)">
                                <span class="truncate px-1">{{ seg.name }}</span>
                                <!-- 右側拖動手把 (除了最後一個) -->
                                <div v-if="idx < currentAnalysis.segments.length - 1"
                                     class="segment-resize-handle right"
                                     @mousedown.stop="startResize($event, idx)"
                                     @touchstart.stop.prevent="startResize($event, idx)">
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-between mt-2 text-xs opacity-60">
                            <span>0s</span>
                            <span>{{ currentAnalysis.cycleTime }}s</span>
                        </div>
                        <!-- 分段詳細時間 -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mt-4">
                            <div v-for="(seg, idx) in currentAnalysis.segments" :key="'time-'+idx"
                                 class="flex items-center gap-2 text-xs">
                                <div class="w-3 h-3 rounded-full shrink-0"
                                     :style="{ backgroundColor: segmentColors[idx % segmentColors.length] }"></div>
                                <span class="truncate">{{ seg.name }}</span>
                                <span class="font-mono ml-auto">{{ seg.duration.toFixed(1) }}s</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Segments Management -->
            <section v-if="currentView === 'segments'" class="animate-fade-in">
                <header class="flex justify-between items-center mb-6">
                    <div>
                        <div class="text-sm breadcrumbs p-0 mb-1">
                            <ul><li><a>製程分析</a></li><li>分段管理</li></ul>
                        </div>
                        <h1 class="text-2xl font-bold">製程分段管理</h1>
                    </div>
                    <button class="btn btn-primary btn-sm" @click="showSegmentModal = true">
                        <i data-lucide="plus" class="w-4 h-4"></i> 新增分段定義
                    </button>
                </header>

                <div class="alert alert-info shadow-sm mb-6 bg-info/10 border-info/20">
                    <i data-lucide="grip-vertical" class="w-5 h-5"></i>
                    <span>拖拉調整分段順序，定義標準製程分段用於自動識別與比對分析</span>
                </div>

                <!-- Segment Templates - Draggable Cards -->
                <div class="card bg-base-100 shadow-sm border border-base-300">
                    <div class="card-body p-4">
                        <div ref="segmentListRef" class="space-y-2">
                            <div v-for="(seg, idx) in segmentTemplates" :key="seg.id"
                                 :data-id="seg.id"
                                 class="flex items-center gap-2 md:gap-4 p-3 bg-base-200 rounded-lg hover:bg-base-300 transition-colors">
                                <!-- 拖拉把手 -->
                                <div class="drag-handle text-base-content/40 hover:text-base-content touch-none">
                                    <i data-lucide="grip-vertical" class="w-5 h-5"></i>
                                </div>
                                <!-- 順序編號 -->
                                <div class="w-7 h-7 md:w-8 md:h-8 rounded-full flex items-center justify-center text-white text-xs md:text-sm font-bold shrink-0"
                                     :style="{ backgroundColor: segmentColors[idx % segmentColors.length] }">
                                    {{ idx + 1 }}
                                </div>
                                <!-- 分段資訊 -->
                                <div class="flex-1 min-w-0">
                                    <div class="font-semibold text-sm md:text-base truncate">{{ seg.name }}</div>
                                    <div class="text-xs opacity-60 truncate">
                                        {{ seg.standardTime }}s +/- {{ seg.tolerance }}s
                                        <span v-if="seg.keyActions && seg.keyActions.length" class="hidden sm:inline">
                                            | {{ seg.keyActions.join(', ') }}
                                        </span>
                                    </div>
                                </div>
                                <!-- 操作按鈕 -->
                                <div class="flex gap-1 shrink-0">
                                    <button class="btn btn-ghost btn-xs" @click="editSegment(seg)">
                                        <i data-lucide="edit" class="w-3 h-3"></i>
                                    </button>
                                    <button class="btn btn-ghost btn-xs text-error" @click="deleteSegment(seg)">
                                        <i data-lucide="trash-2" class="w-3 h-3"></i>
                                    </button>
                                </div>
                            </div>
                            <div v-if="segmentTemplates.length === 0" class="text-center py-8 opacity-60">
                                <i data-lucide="layers" class="w-12 h-12 mx-auto mb-2"></i>
                                <p>尚無分段定義，點擊右上角新增</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Total Standard Time -->
                <div class="card bg-base-100 shadow-sm border border-base-300 mt-6" v-if="segmentTemplates.length > 0">
                    <div class="card-body">
                        <div class="flex justify-between items-center">
                            <span class="font-semibold">標準週期時間</span>
                            <span class="text-2xl font-bold text-primary">
                                {{ segmentTemplates.reduce((sum, s) => sum + s.standardTime, 0) }}s
                            </span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Comparison -->
            <section v-if="currentView === 'comparison'" class="animate-fade-in">
                <header class="flex justify-between items-center mb-6">
                    <div>
                        <div class="text-sm breadcrumbs p-0 mb-1">
                            <ul><li><a>製程分析</a></li><li>改善比對</li></ul>
                        </div>
                        <h1 class="text-2xl font-bold">改善前後比對</h1>
                    </div>
                </header>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Before -->
                    <div class="card bg-base-100 shadow-sm border border-base-300">
                        <div class="card-body">
                            <h2 class="card-title text-sm font-bold text-error">改善前</h2>
                            <div class="aspect-video bg-base-300 rounded-lg flex items-center justify-center">
                                <i data-lucide="video" class="w-12 h-12 opacity-40"></i>
                            </div>
                            <select class="select select-bordered w-full mt-4" v-model="beforeVideoId" @change="loadBeforeAnalysis">
                                <option value="">-- 選擇改善前影片 --</option>
                                <option v-for="v in analyzedVideos" :key="v.id" :value="v.id">{{ v.name }}</option>
                            </select>

                            <!-- Before Timeline -->
                            <div v-if="beforeAnalysis" class="mt-4">
                                <div class="segment-bar">
                                    <div v-for="(seg, idx) in beforeAnalysis.segments" :key="idx"
                                         class="segment-item"
                                         :style="{
                                             width: ((seg.duration / beforeAnalysis.cycleTime) * 100) + '%',
                                             backgroundColor: segmentColors[idx % segmentColors.length]
                                         }">
                                    </div>
                                </div>
                                <div class="stats shadow w-full mt-4">
                                    <div class="stat p-3">
                                        <div class="stat-title text-xs">週期時間</div>
                                        <div class="stat-value text-error text-lg">{{ beforeAnalysis.cycleTime }}s</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- After -->
                    <div class="card bg-base-100 shadow-sm border border-base-300">
                        <div class="card-body">
                            <h2 class="card-title text-sm font-bold text-success">改善後</h2>
                            <div class="aspect-video bg-base-300 rounded-lg flex items-center justify-center">
                                <i data-lucide="video" class="w-12 h-12 opacity-40"></i>
                            </div>
                            <select class="select select-bordered w-full mt-4" v-model="afterVideoId" @change="loadAfterAnalysis">
                                <option value="">-- 選擇改善後影片 --</option>
                                <option v-for="v in analyzedVideos" :key="v.id" :value="v.id">{{ v.name }}</option>
                            </select>

                            <!-- After Timeline -->
                            <div v-if="afterAnalysis" class="mt-4">
                                <div class="segment-bar">
                                    <div v-for="(seg, idx) in afterAnalysis.segments" :key="idx"
                                         class="segment-item"
                                         :style="{
                                             width: ((seg.duration / afterAnalysis.cycleTime) * 100) + '%',
                                             backgroundColor: segmentColors[idx % segmentColors.length]
                                         }">
                                    </div>
                                </div>
                                <div class="stats shadow w-full mt-4">
                                    <div class="stat p-3">
                                        <div class="stat-title text-xs">週期時間</div>
                                        <div class="stat-value text-success text-lg">{{ afterAnalysis.cycleTime }}s</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Improvement Summary -->
                <div class="card bg-base-100 shadow-sm border border-base-300 mt-6" v-if="beforeAnalysis && afterAnalysis">
                    <div class="card-body">
                        <h2 class="card-title text-sm font-bold">改善效果分析</h2>
                        <div class="grid grid-cols-4 gap-4 mt-4">
                            <div class="text-center p-4 bg-success/10 rounded-lg">
                                <div class="text-3xl font-bold text-success">
                                    {{ (((beforeAnalysis.cycleTime - afterAnalysis.cycleTime) / beforeAnalysis.cycleTime) * 100).toFixed(0) }}%
                                </div>
                                <div class="text-sm opacity-60">週期時間縮短</div>
                            </div>
                            <div class="text-center p-4 bg-primary/10 rounded-lg">
                                <div class="text-3xl font-bold text-primary">
                                    {{ (beforeAnalysis.cycleTime - afterAnalysis.cycleTime).toFixed(1) }}s
                                </div>
                                <div class="text-sm opacity-60">節省時間</div>
                            </div>
                            <div class="text-center p-4 bg-warning/10 rounded-lg">
                                <div class="text-3xl font-bold text-warning">
                                    {{ Math.max(...beforeAnalysis.segments.map(s => s.duration)).toFixed(1) }}s
                                </div>
                                <div class="text-sm opacity-60">原瓶頸工時</div>
                            </div>
                            <div class="text-center p-4 bg-info/10 rounded-lg">
                                <div class="text-3xl font-bold text-info">
                                    {{ Math.max(...afterAnalysis.segments.map(s => s.duration)).toFixed(1) }}s
                                </div>
                                <div class="text-sm opacity-60">改善後瓶頸</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Settings -->
            <section v-if="currentView === 'settings'" class="animate-fade-in">
                <header class="flex justify-between items-center mb-6">
                    <div>
                        <div class="text-sm breadcrumbs p-0 mb-1">
                            <ul><li><a>系統</a></li><li>設定</li></ul>
                        </div>
                        <h1 class="text-2xl font-bold">系統設定</h1>
                    </div>
                </header>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- API Settings -->
                    <div class="card bg-base-100 shadow-sm border border-base-300">
                        <div class="card-body">
                            <h2 class="card-title text-sm font-bold">API 設定</h2>
                            <div class="form-control mb-4">
                                <label class="label"><span class="label-text">後端 API URL</span></label>
                                <input type="text" class="input input-bordered" v-model="settings.apiUrl">
                            </div>
                            <button class="btn btn-primary btn-sm" @click="saveSettings">儲存設定</button>
                        </div>
                    </div>

                    <!-- System Status -->
                    <div class="card bg-base-100 shadow-sm border border-base-300">
                        <div class="card-body">
                            <h2 class="card-title text-sm font-bold">系統狀態</h2>
                            <div class="grid grid-cols-2 gap-4 mt-4">
                                <div class="stat bg-base-200 rounded-lg p-3">
                                    <div class="stat-title text-xs">後端連線</div>
                                    <div class="stat-value text-lg" :class="apiStatus === 'connected' ? 'text-success' : 'text-error'">
                                        {{ apiStatus === 'connected' ? '正常' : '斷線' }}
                                    </div>
                                </div>
                                <div class="stat bg-base-200 rounded-lg p-3">
                                    <div class="stat-title text-xs">影片數量</div>
                                    <div class="stat-value text-lg">{{ videos.length }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

        </main>

        <!-- New Segment Modal -->
        <dialog id="segment_modal" class="modal" :class="{ 'modal-open': showSegmentModal }">
            <div class="modal-box">
                <h3 class="font-bold text-lg mb-4">新增分段定義</h3>
                <div class="space-y-4">
                    <div class="form-control">
                        <label class="label"><span class="label-text">分段名稱</span></label>
                        <input type="text" class="input input-bordered" v-model="newSegment.name" placeholder="例如：取料">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-control">
                            <label class="label"><span class="label-text">標準時間 (秒)</span></label>
                            <input type="number" class="input input-bordered" v-model.number="newSegment.standardTime" placeholder="5">
                        </div>
                        <div class="form-control">
                            <label class="label"><span class="label-text">容許範圍 (秒)</span></label>
                            <input type="number" class="input input-bordered" v-model.number="newSegment.tolerance" placeholder="1">
                        </div>
                    </div>
                    <div class="form-control">
                        <label class="label"><span class="label-text">關鍵動作 (逗號分隔)</span></label>
                        <input type="text" class="input input-bordered" v-model="newSegment.keyActionsText" placeholder="拿取, 移動, 放置">
                    </div>
                </div>
                <div class="modal-action">
                    <button class="btn" @click="showSegmentModal = false">取消</button>
                    <button class="btn btn-primary" @click="addSegmentTemplate">新增</button>
                </div>
            </div>
            <form method="dialog" class="modal-backdrop" @click="showSegmentModal = false">
                <button>close</button>
            </form>
        </dialog>

        <!-- Compress Modal -->
        <dialog id="compress_modal" class="modal" :class="{ 'modal-open': showCompressModal }">
            <div class="modal-box">
                <h3 class="font-bold text-lg text-error mb-4">檔案太大</h3>
                <p class="mb-2">
                    <strong>{{ oversizedFileName }}</strong> ({{ oversizedFileSize }}MB) 超過 100MB 限制。
                </p>
                <p class="text-sm opacity-70 mb-4">
                    Cloudinary 免費方案限制單檔最大 100MB，請先壓縮影片再上傳。
                </p>
                <div class="bg-base-200 p-4 rounded-lg mb-4">
                    <p class="font-semibold mb-2">推薦壓縮工具：</p>
                    <ul class="text-sm space-y-2">
                        <li>
                            <a href="https://handbrake.fr/" target="_blank" class="link link-primary">HandBrake</a>
                            <span class="opacity-60">（免費桌面軟體，選 Fast 720p30）</span>
                        </li>
                        <li>
                            <a href="https://www.freeconvert.com/video-compressor" target="_blank" class="link link-primary">FreeConvert</a>
                            <span class="opacity-60">（線上工具，免安裝）</span>
                        </li>
                        <li>
                            <a href="https://cloudconvert.com/video-compressor" target="_blank" class="link link-primary">CloudConvert</a>
                            <span class="opacity-60">（線上工具，支援多格式）</span>
                        </li>
                    </ul>
                </div>
                <div class="modal-action">
                    <button class="btn" @click="showCompressModal = false">關閉</button>
                </div>
            </div>
            <form method="dialog" class="modal-backdrop" @click="showCompressModal = false">
                <button>close</button>
            </form>
        </dialog>

    </div>

    <script>
        const { createApp, ref, reactive, computed, onMounted, nextTick, watch } = Vue;

        const API_BASE = 'https://smai-mcp-center.onrender.com/api/aoi';

        createApp({
            setup() {
                const currentView = ref('dashboard');
                const dragOver = ref(false);
                const showSegmentModal = ref(false);
                const apiStatus = ref('unknown');

                // Upload state
                const isUploading = ref(false);
                const uploadStatus = ref('');
                const uploadProgress = ref(0);
                const currentUploadingFile = ref('');

                // Analysis state
                const isAnalyzing = ref(false);

                // Segment list ref for drag & drop
                const segmentListRef = ref(null);
                let sortableInstance = null;

                // Timeline resize refs
                const timelineRef = ref(null);
                let isResizing = false;
                let resizeSegmentIdx = -1;
                let resizeStartX = 0;
                let resizeStartWidth = 0;

                // Segment colors
                const segmentColors = ['#3b82f6', '#22c55e', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6', '#f97316'];

                // Stats - from API
                const stats = reactive({
                    videoCount: 0,
                    analyzedCount: 0,
                    segmentCount: 0,
                    avgCycleTime: 0,
                    cycleImprovement: 0
                });

                // Data - from API
                const videos = ref([]);
                const recentAnalysis = ref([]);
                const segmentTemplates = ref([]);
                const selectedAnalysisVideoId = ref('');
                const selectedAnalysisVideo = ref(null);
                const currentAnalysis = ref(null);
                const beforeVideoId = ref('');
                const afterVideoId = ref('');
                const beforeAnalysis = ref(null);
                const afterAnalysis = ref(null);

                const newSegment = reactive({
                    name: '',
                    standardTime: 5,
                    tolerance: 1,
                    keyActionsText: ''
                });

                // Settings
                const settings = reactive({
                    apiUrl: 'https://smai-mcp-center.onrender.com'
                });

                // Computed
                const analyzedVideos = computed(() => videos.value.filter(v => v.status === 'analyzed'));

                // Methods
                const updateIcons = () => {
                    nextTick(() => { lucide.createIcons(); });
                };

                // Check API connection
                const checkApiStatus = async () => {
                    try {
                        const response = await fetch(`${API_BASE}/videos`);
                        apiStatus.value = response.ok ? 'connected' : 'disconnected';
                    } catch (e) {
                        apiStatus.value = 'disconnected';
                    }
                };

                // Load stats from API
                const refreshDashboard = async () => {
                    try {
                        const response = await fetch(`${API_BASE}/pv/stats`);
                        if (response.ok) {
                            const data = await response.json();
                            if (data.success && data.data) {
                                Object.assign(stats, data.data);
                            }
                        }
                    } catch (e) {
                        console.error('載入統計失敗:', e);
                    }
                };

                // Load videos from API
                const loadVideos = async () => {
                    try {
                        const response = await fetch(`${API_BASE}/videos`);
                        if (response.ok) {
                            const data = await response.json();
                            if (data.success && data.data) {
                                videos.value = data.data.map(v => ({
                                    ...v,
                                    statusBadge: v.status === 'analyzed' ? 'badge-success' :
                                                 v.status === 'analyzing' ? 'badge-info' : 'badge-warning'
                                }));
                            }
                        }
                    } catch (e) {
                        console.error('載入影片失敗:', e);
                    }
                    await refreshDashboard();
                    updateIcons();
                };

                // Load recent analysis from API
                const loadRecentAnalysis = async () => {
                    try {
                        const response = await fetch(`${API_BASE}/pv/recent`);
                        if (response.ok) {
                            const data = await response.json();
                            if (data.success && data.data) {
                                recentAnalysis.value = data.data;
                            }
                        }
                    } catch (e) {
                        console.error('載入最近分析失敗:', e);
                        recentAnalysis.value = [];
                    }
                };

                // Load segment templates from API
                const loadSegmentTemplates = async () => {
                    try {
                        const response = await fetch(`${API_BASE}/pv/segments`);
                        if (response.ok) {
                            const data = await response.json();
                            if (data.success && data.data) {
                                segmentTemplates.value = data.data;
                            }
                        }
                    } catch (e) {
                        console.error('載入分段定義失敗:', e);
                        segmentTemplates.value = [];
                    }
                };

                const handleFileSelect = (e) => {
                    uploadFiles(e.target.files);
                };

                const handleDrop = (e) => {
                    dragOver.value = false;
                    uploadFiles(e.dataTransfer.files);
                };

                // Cloudinary 設定
                const CLOUDINARY_CLOUD_NAME = 'doihwr1vi';
                const CLOUDINARY_UPLOAD_PRESET = 'process-vision';
                const MAX_FILE_SIZE = 100 * 1024 * 1024; // 100MB (Cloudinary 免費方案限制)

                // 顯示壓縮提示 Modal
                const showCompressModal = ref(false);
                const oversizedFileName = ref('');
                const oversizedFileSize = ref('');

                // 上傳檔案到 Cloudinary
                const uploadFiles = async (files) => {
                    if (files.length === 0) return;

                    // 先檢查所有檔案大小
                    for (const file of files) {
                        if (file.size > MAX_FILE_SIZE) {
                            oversizedFileName.value = file.name;
                            oversizedFileSize.value = (file.size / 1024 / 1024).toFixed(1);
                            showCompressModal.value = true;
                            return;
                        }
                    }

                    isUploading.value = true;
                    uploadProgress.value = 0;

                    try {
                        for (let i = 0; i < files.length; i++) {
                            const file = files[i];
                            const sizeMB = (file.size / 1024 / 1024).toFixed(1);

                            currentUploadingFile.value = file.name;
                            uploadStatus.value = `上傳中 (${i + 1}/${files.length}) - ${sizeMB}MB...`;
                            uploadProgress.value = Math.round((i / files.length) * 50);

                            // 上傳到 Cloudinary
                            const formData = new FormData();
                            formData.append('file', file);
                            formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                            formData.append('folder', 'process-vision');

                            const response = await fetch(
                                `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/video/upload`,
                                { method: 'POST', body: formData }
                            );

                            if (!response.ok) {
                                const errorData = await response.json().catch(() => ({}));
                                throw new Error(errorData?.error?.message || 'Cloudinary 上傳失敗');
                            }

                            const cloudinaryData = await response.json();
                            uploadStatus.value = `儲存資料...`;
                            uploadProgress.value = Math.round(((i + 1) / files.length) * 90);

                            // 註冊到後端資料庫
                            const registerResponse = await fetch(`${API_BASE}/videos/register`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    name: file.name,
                                    public_id: cloudinaryData.public_id,
                                    secure_url: cloudinaryData.secure_url,
                                    duration: cloudinaryData.duration || 0,
                                    bytes: cloudinaryData.bytes || 0,
                                    width: cloudinaryData.width,
                                    height: cloudinaryData.height
                                })
                            });

                            if (!registerResponse.ok) {
                                const errorData = await registerResponse.json().catch(() => ({}));
                                throw new Error(errorData.detail || '儲存失敗');
                            }
                        }

                        uploadStatus.value = '上傳完成!';
                        uploadProgress.value = 100;

                        await loadVideos();
                        await refreshDashboard();

                        setTimeout(() => {
                            isUploading.value = false;
                            uploadProgress.value = 0;
                        }, 1000);

                    } catch (error) {
                        console.error('上傳失敗:', error);
                        uploadStatus.value = `錯誤: ${error.message}`;
                        setTimeout(() => {
                            isUploading.value = false;
                        }, 3000);
                    }
                };

                const viewVideo = (video) => {
                    selectedAnalysisVideoId.value = video.id;
                    selectAnalysisVideo();
                    currentView.value = 'analysis';
                };

                // Analyze video via API
                const analyzeVideo = async (video) => {
                    video.status = 'analyzing';
                    video.statusBadge = 'badge-info';

                    try {
                        const response = await fetch(`${API_BASE}/videos/${video.id}/analyze`, { method: 'POST' });
                        if (response.ok) {
                            const data = await response.json();
                            if (data.success) {
                                video.status = 'analyzed';
                                video.statusBadge = 'badge-success';
                                await refreshDashboard();
                            }
                        }
                    } catch (e) {
                        console.error('分析失敗:', e);
                        video.status = 'error';
                        video.statusBadge = 'badge-error';
                    }
                };

                // Delete video via API
                const deleteVideo = async (video) => {
                    if (!confirm(`確定要刪除「${video.name}」嗎？此操作無法復原。`)) return;

                    try {
                        const response = await fetch(`${API_BASE}/videos/${video.id}`, { method: 'DELETE' });
                        if (response.ok) {
                            await loadVideos();
                            await refreshDashboard();
                        } else {
                            alert('刪除失敗，請稍後再試');
                        }
                    } catch (e) {
                        console.error('刪除失敗:', e);
                        alert('刪除失敗，請稍後再試');
                    }
                };

                const selectAnalysisVideo = () => {
                    selectedAnalysisVideo.value = videos.value.find(v => v.id === selectedAnalysisVideoId.value);
                    currentAnalysis.value = null;
                };

                // Start analysis via API
                const startAnalysis = async () => {
                    if (!selectedAnalysisVideoId.value) return;

                    isAnalyzing.value = true;
                    currentAnalysis.value = null;

                    try {
                        const response = await fetch(`${API_BASE}/videos/${selectedAnalysisVideoId.value}/analyze`, {
                            method: 'POST'
                        });

                        if (response.ok) {
                            const data = await response.json();
                            if (data.success && data.data && data.data.results) {
                                currentAnalysis.value = {
                                    cycleTime: data.data.results.cycle_time,
                                    segments: data.data.results.segments
                                };
                                await loadVideos();
                            }
                        }
                    } catch (e) {
                        console.error('分析失敗:', e);
                    } finally {
                        isAnalyzing.value = false;
                    }
                };

                const jumpToSegment = (seg) => {
                    if (selectedAnalysisVideo.value && selectedAnalysisVideo.value.url) {
                        const video = document.querySelector('video');
                        if (video) {
                            video.currentTime = seg.start;
                        }
                    }
                };

                // Load analysis for comparison
                const loadBeforeAnalysis = async () => {
                    if (!beforeVideoId.value) {
                        beforeAnalysis.value = null;
                        return;
                    }

                    try {
                        const response = await fetch(`${API_BASE}/videos/${beforeVideoId.value}/analysis`);
                        if (response.ok) {
                            const data = await response.json();
                            if (data.success && data.data) {
                                beforeAnalysis.value = data.data;
                            }
                        }
                    } catch (e) {
                        console.error('載入分析失敗:', e);
                    }
                };

                const loadAfterAnalysis = async () => {
                    if (!afterVideoId.value) {
                        afterAnalysis.value = null;
                        return;
                    }

                    try {
                        const response = await fetch(`${API_BASE}/videos/${afterVideoId.value}/analysis`);
                        if (response.ok) {
                            const data = await response.json();
                            if (data.success && data.data) {
                                afterAnalysis.value = data.data;
                            }
                        }
                    } catch (e) {
                        console.error('載入分析失敗:', e);
                    }
                };

                // Add segment template via API
                const addSegmentTemplate = async () => {
                    try {
                        const response = await fetch(`${API_BASE}/pv/segments`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                name: newSegment.name,
                                standardTime: newSegment.standardTime,
                                tolerance: newSegment.tolerance,
                                keyActions: newSegment.keyActionsText.split(',').map(s => s.trim()).filter(s => s)
                            })
                        });

                        if (response.ok) {
                            await loadSegmentTemplates();
                            showSegmentModal.value = false;
                            newSegment.name = '';
                            newSegment.standardTime = 5;
                            newSegment.tolerance = 1;
                            newSegment.keyActionsText = '';
                        }
                    } catch (e) {
                        console.error('新增分段失敗:', e);
                    }
                };

                const editSegment = (seg) => {
                    // TODO: Implement edit modal
                    console.log('Edit segment:', seg.name);
                };

                // Delete segment via API
                const deleteSegment = async (seg) => {
                    if (!confirm(`確定要刪除「${seg.name}」嗎？`)) return;

                    try {
                        const response = await fetch(`${API_BASE}/pv/segments/${seg.id}`, {
                            method: 'DELETE'
                        });

                        if (response.ok) {
                            await loadSegmentTemplates();
                        }
                    } catch (e) {
                        console.error('刪除分段失敗:', e);
                    }
                };

                // Initialize Sortable for segment list
                const initSortable = () => {
                    if (sortableInstance) {
                        sortableInstance.destroy();
                        sortableInstance = null;
                    }

                    if (segmentListRef.value && segmentTemplates.value.length > 0) {
                        sortableInstance = new Sortable(segmentListRef.value, {
                            animation: 150,
                            handle: '.drag-handle',
                            ghostClass: 'sortable-ghost',
                            dragClass: 'sortable-drag',
                            onEnd: async (evt) => {
                                if (evt.oldIndex === evt.newIndex) return;

                                // 更新本地順序
                                const item = segmentTemplates.value.splice(evt.oldIndex, 1)[0];
                                segmentTemplates.value.splice(evt.newIndex, 0, item);

                                // 呼叫 API 更新順序
                                await updateSegmentOrder();
                                updateIcons();
                            }
                        });
                    }
                };

                // Update segment order via API
                const updateSegmentOrder = async () => {
                    try {
                        const orderData = segmentTemplates.value.map((seg, idx) => ({
                            id: seg.id,
                            sort_order: idx
                        }));

                        const response = await fetch(`${API_BASE}/pv/segments/reorder`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ segments: orderData })
                        });

                        if (!response.ok) {
                            console.error('更新順序失敗');
                            // 重新載入以還原
                            await loadSegmentTemplates();
                        }
                    } catch (e) {
                        console.error('更新順序失敗:', e);
                        await loadSegmentTemplates();
                    }
                };

                // Timeline resize handlers
                const startResize = (e, segmentIdx) => {
                    if (!currentAnalysis.value || !timelineRef.value) return;

                    isResizing = true;
                    resizeSegmentIdx = segmentIdx;
                    resizeStartX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;

                    // 計算 timeline 總寬度
                    const timelineWidth = timelineRef.value.offsetWidth;

                    // 加入事件監聽
                    document.addEventListener('mousemove', doResize);
                    document.addEventListener('mouseup', endResize);
                    document.addEventListener('touchmove', doResize, { passive: false });
                    document.addEventListener('touchend', endResize);
                    document.body.style.cursor = 'ew-resize';
                    document.body.style.userSelect = 'none';
                };

                const doResize = (e) => {
                    if (!isResizing || resizeSegmentIdx < 0 || !currentAnalysis.value || !timelineRef.value) return;

                    e.preventDefault();
                    const currentX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
                    const deltaX = currentX - resizeStartX;
                    resizeStartX = currentX;

                    const timelineWidth = timelineRef.value.offsetWidth;
                    const cycleTime = currentAnalysis.value.cycleTime;

                    // 轉換像素差距為時間差距
                    const deltaTime = (deltaX / timelineWidth) * cycleTime;

                    const segments = currentAnalysis.value.segments;
                    const current = segments[resizeSegmentIdx];
                    const next = segments[resizeSegmentIdx + 1];

                    if (!current || !next) return;

                    // 計算新的時長，限制最小 0.5 秒
                    const newCurrentDuration = current.duration + deltaTime;
                    const newNextDuration = next.duration - deltaTime;

                    if (newCurrentDuration >= 0.5 && newNextDuration >= 0.5) {
                        current.duration = Math.round(newCurrentDuration * 10) / 10;
                        current.end = Math.round((current.start + current.duration) * 10) / 10;

                        next.duration = Math.round(newNextDuration * 10) / 10;
                        next.start = current.end;
                    }
                };

                const endResize = () => {
                    isResizing = false;
                    resizeSegmentIdx = -1;

                    document.removeEventListener('mousemove', doResize);
                    document.removeEventListener('mouseup', endResize);
                    document.removeEventListener('touchmove', doResize);
                    document.removeEventListener('touchend', endResize);
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                };

                const saveSettings = () => {
                    localStorage.setItem('pv_settings', JSON.stringify(settings));
                    alert('設定已儲存');
                };

                const loadSettings = () => {
                    const saved = localStorage.getItem('pv_settings');
                    if (saved) Object.assign(settings, JSON.parse(saved));
                };

                // Initialize
                onMounted(async () => {
                    updateIcons();
                    loadSettings();
                    await checkApiStatus();
                    await loadVideos();
                    await loadRecentAnalysis();
                    await loadSegmentTemplates();
                });

                // Watch for view changes to initialize Sortable
                watch(currentView, async (newView) => {
                    if (newView === 'segments') {
                        await nextTick();
                        initSortable();
                    }
                    updateIcons();
                });

                // Watch for segment templates changes
                watch(segmentTemplates, async () => {
                    if (currentView.value === 'segments') {
                        await nextTick();
                        initSortable();
                    }
                }, { deep: true });

                return {
                    currentView,
                    dragOver,
                    showSegmentModal,
                    showCompressModal,
                    oversizedFileName,
                    oversizedFileSize,
                    apiStatus,
                    segmentColors,
                    stats,
                    videos,
                    recentAnalysis,
                    segmentTemplates,
                    selectedAnalysisVideoId,
                    selectedAnalysisVideo,
                    currentAnalysis,
                    beforeVideoId,
                    afterVideoId,
                    beforeAnalysis,
                    afterAnalysis,
                    analyzedVideos,
                    newSegment,
                    settings,
                    // Upload
                    isUploading,
                    uploadStatus,
                    uploadProgress,
                    currentUploadingFile,
                    // Analysis
                    isAnalyzing,
                    // Segment drag
                    segmentListRef,
                    // Timeline resize
                    timelineRef,
                    startResize,
                    // Methods
                    refreshDashboard,
                    handleFileSelect,
                    handleDrop,
                    viewVideo,
                    analyzeVideo,
                    deleteVideo,
                    selectAnalysisVideo,
                    startAnalysis,
                    jumpToSegment,
                    loadBeforeAnalysis,
                    loadAfterAnalysis,
                    addSegmentTemplate,
                    editSegment,
                    deleteSegment,
                    saveSettings
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
